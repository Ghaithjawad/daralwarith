<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>Ø§Ø³ØªÙ…Ø§Ø±Ø© ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¸ÙÙŠ Ø¯Ø§Ø± Ø§Ù„ÙˆØ§Ø±Ø«</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{--main:#1aa6a6;--dark:#148c8c;--border:#d9eeee;--text:#0f3f3f;}
body{
  font-family:"Segoe UI",Tahoma,sans-serif;
  color:var(--text);
  background-image:url("https://i.suar.me/0A8qj/m");
  background-repeat:repeat;
  background-size:420px 420px;
  background-attachment:fixed;
}
.container{
  background:#ffffff;border-radius:22px;padding:30px;margin:30px auto 25px;
  box-shadow:0 18px 40px rgba(0,0,0,.18);
  max-width:980px;
}
.header{
  background:linear-gradient(135deg,var(--main),var(--dark));
  color:#fff;padding:26px;border-radius:18px;text-align:center;margin-bottom:22px;
}
.logo{max-width:150px;display:block;margin:auto;}
.card{border:1px solid var(--border);border-radius:16px;margin-bottom:18px;}
.section{
  border:2px dashed var(--main);border-radius:14px;padding:16px;margin-top:14px;background:#f9fefe;
}
.check-box{border:1.8px solid var(--main);border-radius:12px;padding:12px 16px;background:#f6fdfd;}
.form-check-input{width:18px;height:18px;margin-left:10px;}
.form-check-input:checked{background-color:var(--main);border-color:var(--main);}
button.main-btn{
  background:var(--main);border:none;padding:14px 16px;font-size:18px;border-radius:14px;color:#fff;
}
button.main-btn:hover{background:var(--dark);}
.preview-img{
  max-height:180px;width:100%;object-fit:contain;border-radius:12px;border:1px solid #e8e8e8;background:#fff;
}
.cam-wrap{position:relative;width:100%;}
#camVideo{width:100%;border-radius:12px;background:#000;}
.cam-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;}
.id-frame{
  width:72%;
  aspect-ratio:8.7/5.3;
  border:4px solid red;
  border-radius:14px;
  box-shadow:0 0 0 2000px rgba(0,0,0,.45);
}
.footer-note{text-align:center;margin:14px auto 25px;color:#0f3f3f;opacity:.85;font-weight:600;}
.small-note{font-size:.9rem;color:#666;}
.req-hint{font-size:.85rem;color:#b42318;display:none;}
.req-hint.show{display:block;}
.tip{background:#f2fffe;border:1px solid #cfeeee;border-radius:12px;padding:10px 12px;color:#0f3f3f;font-size:.92rem;}
</style>
</head>
<body>
<!-- ===== LOGIN PAGE ===== -->
<div id="loginPage" class="container" style="max-width:720px;">
  <div class="header">
    <img src="https://i.suar.me/A3aKJ/m" class="logo mb-2" alt="Ø¯Ø§Ø± Ø§Ù„ÙˆØ§Ø±Ø«">
    <h4 class="mb-1">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h4>
    <p class="mb-0">Ø§Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… (Ø«Ù†Ø§Ø¦ÙŠ/Ø«Ù„Ø§Ø«ÙŠ) + Ø±Ù‚Ù… Ø§Ù„Ù€ ID Ù„Ù„Ø¯Ø®ÙˆÙ„</p>
  </div>
  <div id="secureWarn" class="alert alert-warning d-none">
    Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ø§ ØªØ¹Ù…Ù„ Ø¥Ù„Ø§ Ø¹Ù„Ù‰ <b>HTTPS</b> Ø£Ùˆ <b>localhost</b>. Ø¹Ù„Ù‰ GitHub Pages Ø±Ø§Ø­ ØªØ´ØªØºÙ„.
  </div>
  <div id="loginStatus" class="alert d-none"></div>
  <div class="card p-4">
    <label class="fw-bold">Ø§Ù„Ø§Ø³Ù…</label>
    <input id="loginName" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÙŠ Ø­Ø³Ù† / Ø¹Ù„ÙŠ Ø­Ø³Ù† Ø¹Ø¨Ø§Ø³">
    <div class="small-note mt-2">Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ù…Ø«Ù„ Ø§Ù„Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
  </div>
  <div class="card p-4">
    <label class="fw-bold">Ø±Ù‚Ù… Ø§Ù„Ù€ ID</label>
    <input id="loginId" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 1023">
  </div>
  <div id="loginError" class="alert alert-danger d-none">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©</div>
  <button class="w-100 main-btn" type="button" onclick="doLogin()">Ø¯Ø®ÙˆÙ„</button>
</div>
<!-- ===== FORM PAGE ===== -->
<div id="formPage" class="d-none">
  <div class="container">
    <div class="header">
      <img src="https://i.suar.me/A3aKJ/m" class="logo mb-2" alt="Ø¯Ø§Ø± Ø§Ù„ÙˆØ§Ø±Ø«">
      <h4 class="mb-1">Ø§Ø³ØªÙ…Ø§Ø±Ø© ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¸ÙÙŠ Ø¯Ø§Ø± Ø§Ù„ÙˆØ§Ø±Ø«</h4>
      <p class="mb-0">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ±ÙØ¹ Ø§Ù„Ù…Ø³ØªÙ…Ø³ÙƒØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</p>
      <div class="mt-3 d-flex justify-content-center gap-2">
        <button type="button" class="btn btn-light btn-sm" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
    <div id="sheetStatus" class="alert d-none"></div>
    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù -->
    <div class="card p-4">
      <label class="fw-bold">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</label>
      <input type="text" id="employeeName" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ Ø­Ø³Ù† Ø¹Ø¨Ø§Ø³">
      <div id="nameError" class="req-hint">Ø§Ù„Ø§Ø³Ù… Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† 4 ÙƒÙ„Ù…Ø§Øª Ø¨Ø§Ù„Ø¶Ø¨Ø·</div>
      <div class="small-note mt-2">Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø§Ø³Ù… Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø¹Ø¯Ù„Ù‡ Ù„Ù„Ø±Ø¨Ø§Ø¹ÙŠ Ø¥Ø°Ø§ ÙŠØ­ØªØ§Ø¬.</div>
    </div>
    <div class="card p-4">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="fw-bold">Ù…Ø­Ù„ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©</label>
          <input type="text" id="birthPlace" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="fw-bold">Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯ (ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©)</label>
          <input type="date" id="birthDate" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="fw-bold">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
          <input type="tel" id="phone" class="form-control" placeholder="07xxxxxxxxx">
        </div>
        <div class="col-md-6">
          <label class="fw-bold">Ø±Ù‚Ù… Ø¨Ø§Ø¬ Ø§Ù„Ø¹ØªØ¨Ø© Ø§Ù„Ø­Ø³ÙŠÙ†ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ø³Ø©</label>
          <input type="text" id="badgeNumber" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="fw-bold">Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
          <select id="education" class="form-control">
            <option value="">Ø§Ø®ØªØ±</option>
            <option>Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©</option><option>Ù…ØªÙˆØ³Ø·Ø©</option><option>Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©</option>
            <option>Ø¯Ø¨Ù„ÙˆÙ…</option><option>Ø¨ÙƒØ§Ù„ÙˆØ±ÙŠÙˆØ³</option><option>Ù…Ø§Ø¬Ø³ØªÙŠØ±</option><option>Ø¯ÙƒØªÙˆØ±Ø§Ù‡</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="fw-bold">Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ø¯Ù‚ÙŠÙ‚</label>
          <input type="text" id="specialty" class="form-control">
        </div>
        <div class="col-12">
          <label class="fw-bold">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³ÙƒÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ</label>
          <textarea id="address" class="form-control" rows="2"></textarea>
        </div>
      </div>
    </div>
   
    <!-- Ø§Ù„ÙˆØ·Ù†ÙŠØ© -->
    <div class="card p-4">
      <h5 class="mb-2">Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ© Ù„Ù„Ù…ÙˆØ¸Ù <span class="text-muted">(Ù‚Øµ Ø°ÙƒÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø±)</span></h5>
      <div class="tip mb-3">Ø¶Ø¹ Ø§Ù„Ù‡ÙˆÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø±ØŒ ÙŠØµÙŠØ± Ø£Ø®Ø¶Ø± Ø«Ù… ÙŠÙ„ØªÙ‚Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>
      <div class="mb-3">
        <label class="fw-bold mb-2 d-block">ÙˆØ¬Ù‡ Ø§Ù„Ù‡ÙˆÙŠØ©</label>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('empFace')">ÙƒØ§Ù…ÙŠØ±Ø§</button>
          <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('empFace')">Ø§Ø³ØªÙˆØ¯ÙŠÙˆ</button>
        </div>
        <input type="file" id="empFace" class="form-control d-none" accept="image/*">
        <img id="empFacePreview" class="preview-img mt-2 d-none" alt="preview">
      </div>
      <div>
        <label class="fw-bold mb-2 d-block">Ø¸Ù‡Ø± Ø§Ù„Ù‡ÙˆÙŠØ©</label>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('empBack')">ÙƒØ§Ù…ÙŠØ±Ø§</button>
          <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('empBack')">Ø§Ø³ØªÙˆØ¯ÙŠÙˆ</button>
        </div>
        <input type="file" id="empBack" class="form-control d-none" accept="image/*">
        <img id="empBackPreview" class="preview-img mt-2 d-none" alt="preview">
      </div>
    </div>
     <!-- Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© -->
    <div class="card p-4">
      <label class="fw-bold mb-2 d-block">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</label>
      <select id="maritalStatus" class="form-control">
        <option value="">Ø§Ø®ØªØ±</option>
        <option value="single">Ø£Ø¹Ø²Ø¨</option>
        <option value="married">Ù…ØªØ²ÙˆØ¬</option>
      </select>
      <div id="socialSection" class="section d-none">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="fw-bold">Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙˆØ¬Ø§Øª</label>
            <input type="number" id="wivesCount" min="1" value="1" class="form-control">
          </div>
          <div class="col-12">
            <div class="tip mb-2">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²ÙˆØ¬Ø§Øª + Ø±ÙØ¹ Ù‡ÙˆÙŠØ§ØªÙ‡Ù† (Ù‚Øµ Ø°ÙƒÙŠ)</div>
            <div id="wivesInfo"></div>
            <div id="wivesUploads"></div>
          </div>
          <div class="col-md-6">
            <label class="fw-bold">Ø§Ø³Ù… Ø£Ù… Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡</label>
            <input type="text" id="childrenMother" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="fw-bold">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡</label>
            <input type="number" id="childrenCount" min="0" value="0" class="form-control">
          </div>
          <div class="col-12">
            <div class="tip mb-2">Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡ + Ø±ÙØ¹ Ù‡ÙˆÙŠØ§ØªÙ‡Ù… (Ù‚Øµ Ø°ÙƒÙŠ)</div>
            <div id="childrenNamesWrap"></div>
            <div id="childrenUploads"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- Ø§Ù„Ø³ÙƒÙ† -->
    <div class="card p-4">
      <div class="check-box form-check">
        <label class="form-check-label">Ù‡Ù„ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø© Ø³ÙƒÙ†ØŸ</label>
        <input class="form-check-input" type="checkbox" id="hasResidence">
      </div>
      <div id="residenceSection" class="section d-none">
        <div class="mb-3">
          <label class="fw-bold mb-2 d-block">ÙˆØ¬Ù‡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³ÙƒÙ†</label>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('resFace')">ÙƒØ§Ù…ÙŠØ±Ø§</button>
            <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('resFace')">Ø§Ø³ØªÙˆØ¯ÙŠÙˆ</button>
          </div>
          <input type="file" id="resFace" class="form-control d-none" accept="image/*">
          <img id="resFacePreview" class="preview-img mt-2 d-none" alt="preview">
        </div>
        <div>
          <label class="fw-bold mb-2 d-block">Ø¸Ù‡Ø± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³ÙƒÙ†</label>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('resBack')">ÙƒØ§Ù…ÙŠØ±Ø§</button>
            <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('resBack')">Ø§Ø³ØªÙˆØ¯ÙŠÙˆ</button>
          </div>
          <input type="file" id="resBack" class="form-control d-none" accept="image/*">
          <img id="resBackPreview" class="preview-img mt-2 d-none" alt="preview">
        </div>
      </div>
    </div>
    <!-- Ø¨Ø§Ø¬ Ø§Ù„Ø¹ØªØ¨Ø© -->
    <div class="card p-4">
      <div class="check-box form-check">
        <label class="form-check-label">Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ø¨Ø§Ø¬ Ø§Ù„Ø¹ØªØ¨Ø©ØŸ</label>
        <input class="form-check-input" type="checkbox" id="hasBadge">
      </div>
      <div id="badgeSection" class="section d-none">
        <div class="tip mb-3">Ø¶Ø¹ Ø§Ù„Ø¨Ø§Ø¬ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø±ØŒ ÙŠØµÙŠØ± Ø£Ø®Ø¶Ø± Ø«Ù… ÙŠÙ„ØªÙ‚Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>
        <div class="mb-3">
          <label class="fw-bold mb-2 d-block">ÙˆØ¬Ù‡ Ø§Ù„Ø¨Ø§Ø¬</label>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('badgeFace')">ÙƒØ§Ù…ÙŠØ±Ø§</button>
            <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('badgeFace')">Ø§Ø³ØªÙˆØ¯ÙŠÙˆ</button>
          </div>
          <input type="file" id="badgeFace" class="form-control d-none" accept="image/*">
          <img id="badgeFacePreview" class="preview-img mt-2 d-none" alt="preview">
        </div>
        <div>
          <label class="fw-bold mb-2 d-block">Ø¸Ù‡Ø± Ø§Ù„Ø¨Ø§Ø¬</label>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('badgeBack')">ÙƒØ§Ù…ÙŠØ±Ø§</button>
            <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('badgeBack')">Ø§Ø³ØªÙˆØ¯ÙŠÙˆ</button>
          </div>
          <input type="file" id="badgeBack" class="form-control d-none" accept="image/*">
          <img id="badgeBackPreview" class="preview-img mt-2 d-none" alt="preview">
        </div>
      </div>
    </div>
    <!-- Ø´Ù‡Ø§Ø¯Ø© -->
    <div class="card p-4">
      <div class="check-box form-check">
        <label class="form-check-label">Ù‡Ù„ ØªÙˆØ¬Ø¯ Ø´Ù‡Ø§Ø¯Ø© ØªØ®Ø±Ø¬ØŸ</label>
        <input class="form-check-input" type="checkbox" id="hasCertificate">
      </div>
      <div id="certificateSection" class="section d-none">
        <label class="fw-bold mb-2 d-block">ØµÙˆØ±Ø© Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØªØ®Ø±Ø¬ (Ø¨Ø¯ÙˆÙ† Ù‚Øµ)</label>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('certificateFile')">ÙƒØ§Ù…ÙŠØ±Ø§</button>
          <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('certificateFile')">Ø§Ø³ØªÙˆØ¯ÙŠÙˆ</button>
        </div>
        <input type="file" id="certificateFile" class="form-control d-none" accept="image/*">
        <img id="certificateFilePreview" class="preview-img mt-2 d-none" alt="preview">
      </div>
    </div>
    <button class="w-100 main-btn" onclick="submitAll()">Ø¥Ø±Ø³Ø§Ù„ (Google Sheet + PDF)</button>
    <div class="mt-3 small-note">ØªØ£ÙƒØ¯ ØªØ±ÙØ¹ (ÙˆØ¬Ù‡/Ø¸Ù‡Ø±) Ù„ÙƒÙ„ Ù‡ÙˆÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.</div>
  </div>
  <div class="footer-note">ØªØ·ÙˆÙŠØ± Ø´Ø¹Ø¨Ø© ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ø¯Ø§Ø± Ø§Ù„ÙˆØ§Ø±Ø«</div>
</div>
<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
<div class="modal fade" id="camModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="camTitle">ÙƒØ§Ù…ÙŠØ±Ø§</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="closeCamera()"></button>
      </div>
      <div class="modal-body">
        <div class="cam-wrap">
          <video id="camVideo" autoplay playsinline></video>
          <div class="cam-overlay">
            <div id="idFrame" class="id-frame"></div>
          </div>
        </div>
        <div class="mt-2">
          <small class="text-muted" id="camHint">ÙˆØ¬Ù‘Ù‡ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø±</small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeCamera()">Ø¥ØºÙ„Ø§Ù‚</button>
        <button type="button" class="btn btn-success" onclick="captureNow()">Ø§Ù„ØªÙ‚Ø§Ø·</button>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* =========================
   CONFIG
========================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzMui6fIP6HctPPzxs0C18EaI2LrQp5m98dfb5W3ghOENorKN9qO0WionwWUz4SOxs5/exec";
/* =========================
   HTTPS/localhost check
========================= */
function isCameraAllowedContext(){
  const isLocalhost = ["localhost","127.0.0.1"].includes(location.hostname);
  return window.isSecureContext || isLocalhost;
}
(function(){
  document.getElementById("secureWarn").classList.toggle("d-none", isCameraAllowedContext());
})();
/* =========================
   Login (secure via Apps Script)
========================= */
function showLoginStatus(type, msg){
  const el = document.getElementById("loginStatus");
  el.classList.remove("d-none","alert-success","alert-danger","alert-info");
  el.classList.add("alert", type);
  el.textContent = msg;
}
function showLoginError(msg){
  const el = document.getElementById("loginError");
  el.textContent = msg || "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
  el.classList.remove("d-none");
}
async function doLogin(){
  document.getElementById("loginError").classList.add("d-none");
  const name = (document.getElementById("loginName").value || "").trim();
  const id   = (document.getElementById("loginId").value || "").trim();
  if(!name || !id){
    showLoginError("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù€ ID");
    return;
  }
  showLoginStatus("alert-info", "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...");
  try{
    const body = new URLSearchParams();
    body.set("action","login");
    body.set("name", name);
    body.set("id", id);
    const res = await fetch(SCRIPT_URL, { method:"POST", body });
    const txt = (await res.text()).trim();
   if(txt === "OK"){
  localStorage.setItem("dar_login_id", id);
  localStorage.setItem("dar_login_name", name);

  showLoader();                // ğŸ‘ˆ Ù„ÙˆØ¯Ø±
  document.getElementById("loginPage").classList.add("d-none");

  setTimeout(()=>{
    hideLoader();
    document.getElementById("formPage").classList.remove("d-none");
    employeeName.value = name;
  }, 1200); // Ø«Ø§Ù†ÙŠØ© ÙˆØ±Ø¨Ø¹
  return;
}

    showLoginStatus("alert-danger", "ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚");
    showLoginError("Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù€ ID ØºÙŠØ± ØµØ­ÙŠØ­");
  }catch(e){
    console.error(e);
    showLoginStatus("alert-danger", "Ø®Ø·Ø£ Ø¨Ø§Ù„Ø§ØªØµØ§Ù„");
    showLoginError("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
  }
}
function logout(){
  localStorage.removeItem("dar_login_id");
  localStorage.removeItem("dar_login_name");
  location.reload();
}
/* Auto show form if logged-in (optional) */
(function(){
  const savedId = localStorage.getItem("dar_login_id");
  const savedName = localStorage.getItem("dar_login_name");
  if(savedId && savedName){
    document.addEventListener("DOMContentLoaded", ()=>{
      document.getElementById("loginPage").classList.add("d-none");
      document.getElementById("formPage").classList.remove("d-none");
      if(window.employeeName) employeeName.value = savedName;
    });
  }
})();
/* =========================
   Studio + preview
========================= */
function openStudio(id){ document.getElementById(id)?.click(); }
function bindPreview(id){
  const input = document.getElementById(id);
  input?.addEventListener("change", ()=>{
    const file = input.files && input.files[0];
    const prev = document.getElementById(id+"Preview");
    if(file && prev){
      prev.src = URL.createObjectURL(file);
      prev.classList.remove("d-none");
    }
  });
}
["empFace","empBack","resFace","resBack","badgeFace","badgeBack","certificateFile"].forEach(bindPreview);
/* =========================
   Name validation (quad)
========================= */
function isQuadName(name){
  const w = name.trim().split(/\s+/).filter(Boolean);
  return w.length === 4;
}
employeeName?.addEventListener("input", ()=>{
  document.getElementById("nameError").classList.toggle("show",
    employeeName.value.trim().length>0 && !isQuadName(employeeName.value)
  );
});
/* =========================
   Sections toggles
========================= */
hasResidence.onchange = ()=> residenceSection.classList.toggle("d-none", !hasResidence.checked);
hasBadge.onchange     = ()=> badgeSection.classList.toggle("d-none", !hasBadge.checked);
hasCertificate.onchange = ()=> certificateSection.classList.toggle("d-none", !hasCertificate.checked);
maritalStatus.addEventListener("change", ()=>{
  const married = maritalStatus.value==="married";
  socialSection.classList.toggle("d-none", !married);
  if(!married){
    wivesCount.value=1; wivesInfo.innerHTML=""; wivesUploads.innerHTML="";
    childrenMother.value=""; childrenCount.value=0; childrenNamesWrap.innerHTML=""; childrenUploads.innerHTML="";
  }else{
    renderWivesAll(); renderChildrenAll();
  }
});
wivesCount.addEventListener("input", ()=> maritalStatus.value==="married" && renderWivesAll());
childrenCount.addEventListener("input", ()=> maritalStatus.value==="married" && renderChildrenAll());
/* =========================
   Dynamic wife/child blocks (smart ID uploads)
========================= */
function makeSmartIDBlock(prefix,i){
  const faceId=`${prefix}Face_${i}`, backId=`${prefix}Back_${i}`;
  const title = prefix==="wife" ? `Ù‡ÙˆÙŠØ© Ø§Ù„Ø²ÙˆØ¬Ø© ${i}` : `Ù‡ÙˆÙŠØ© Ø§Ù„Ø·ÙÙ„ ${i}`;
  return `
    <div class="mb-3 p-3 rounded border bg-white">
      <strong class="d-block mb-2">${title}</strong>
      <div class="mb-2">
        <label class="fw-bold mb-1 d-block">ÙˆØ¬Ù‡</label>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('${faceId}')">ÙƒØ§Ù…ÙŠØ±Ø§</button>
          <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('${faceId}')">Ø§Ø³ØªÙˆØ¯ÙŠÙˆ</button>
        </div>
        <input type="file" id="${faceId}" class="form-control d-none" accept="image/*">
        <img id="${faceId}Preview" class="preview-img mt-2 d-none" alt="preview">
      </div>
      <div>
        <label class="fw-bold mb-1 d-block">Ø¸Ù‡Ø±</label>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('${backId}')">ÙƒØ§Ù…ÙŠØ±Ø§</button>
          <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('${backId}')">Ø§Ø³ØªÙˆØ¯ÙŠÙˆ</button>
        </div>
        <input type="file" id="${backId}" class="form-control d-none" accept="image/*">
        <img id="${backId}Preview" class="preview-img mt-2 d-none" alt="preview">
      </div>
    </div>`;
}
function bindDynamic(prefix,n){
  for(let i=1;i<=n;i++){
    bindPreview(`${prefix}Face_${i}`);
    bindPreview(`${prefix}Back_${i}`);
  }
}
function renderWivesAll(){
  const n=Math.max(1,Number(wivesCount.value||1));
  wivesInfo.innerHTML="";
  wivesUploads.innerHTML="";
  for(let i=1;i<=n;i++){
    wivesInfo.innerHTML += `
      <div class="mb-3 p-3 rounded border bg-white">
        <strong class="d-block mb-2">Ø§Ù„Ø²ÙˆØ¬Ø© ${i}</strong>
        <div class="row g-2">
          <div class="col-md-6">
            <label class="fw-bold">Ø§Ø³Ù… Ø§Ù„Ø²ÙˆØ¬Ø© Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label>
            <input type="text" class="form-control" id="wifeName_${i}">
          </div>
          <div class="col-md-6">
            <label class="fw-bold">Ù‡Ù„ Ù‡ÙŠ Ù…ÙˆØ¸ÙØ©ØŸ</label>
            <select class="form-control" id="wifeEmp_${i}">
              <option value="">Ø§Ø®ØªØ±</option><option value="yes">Ù†Ø¹Ù…</option><option value="no">Ù„Ø§</option>
            </select>
          </div>
        </div>
      </div>`;
  }
  for(let i=1;i<=n;i++) wivesUploads.innerHTML += makeSmartIDBlock("wife",i);
  bindDynamic("wife",n);
}
function renderChildrenAll(){
  const n=Math.max(0,Number(childrenCount.value||0));
  childrenNamesWrap.innerHTML="";
  childrenUploads.innerHTML="";
  if(n<=0) return;
  const box=document.createElement("div");
  box.className="section";
  box.innerHTML=`<div class="fw-bold mb-2">Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡</div>`;
  for(let i=1;i<=n;i++){
    const d=document.createElement("div");
    d.className="mb-2";
    d.innerHTML=`<label class="fw-bold">Ø§Ø³Ù… Ø§Ù„Ø§Ø¨Ù† ${i}</label><input type="text" class="form-control" id="childName_${i}">`;
    box.appendChild(d);
  }
  childrenNamesWrap.appendChild(box);
  for(let i=1;i<=n;i++) childrenUploads.innerHTML += makeSmartIDBlock("child",i);
  bindDynamic("child",n);
}
/* =========================
   CAMERA: smart crop for IDs
========================= */
function isSmartIDInput(id){
  if(["empFace","empBack","resFace","resBack","badgeFace","badgeBack"].includes(id)) return true;
  if(/^wife(Face|Back)_\d+$/.test(id)) return true;
  if(/^child(Face|Back)_\d+$/.test(id)) return true;
  return false;
}
let camStream=null, targetInputId=null, camModal=null, validateTimer=null;
let greenSince=null, lastAuto=0, bestShotLock=false;
let captureMode="ID";
async function openCameraFor(id){
  if(!isCameraAllowedContext()){
    alert("Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ´ØªØºÙ„ ÙÙ‚Ø· HTTPS Ø£Ùˆ localhost.");
    return;
  }
  targetInputId=id;
  captureMode = isSmartIDInput(id) ? "ID" : "FULL";
  if(!camModal) camModal=new bootstrap.Modal(document.getElementById("camModal"));
  try{
    camStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:false});
    const v=document.getElementById("camVideo");
    v.srcObject=camStream;
    const frame=document.getElementById("idFrame");
    const title=document.getElementById("camTitle");
    const hint=document.getElementById("camHint");
    if(captureMode==="ID"){
      frame.style.display="block";
      frame.style.borderColor="red";
      title.textContent="ÙƒØ§Ù…ÙŠØ±Ø§ (Ù‚Øµ Ø°ÙƒÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø±)";
      hint.textContent="Ø¶Ø¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø± â€” ÙŠØµÙŠØ± Ø£Ø®Ø¶Ø± Ø«Ù… ÙŠÙ„ØªÙ‚Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹";
      bestShotLock=false; greenSince=null; lastAuto=0;
      if(validateTimer) clearInterval(validateTimer);
      validateTimer=setInterval(()=>validateFrameFast(),110);
    }else{
      frame.style.display="none";
      title.textContent="ÙƒØ§Ù…ÙŠØ±Ø§ (Ø¨Ø¯ÙˆÙ† Ù‚Øµ)";
      hint.textContent="Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© ÙƒØ§Ù…Ù„Ø©";
      if(validateTimer){ clearInterval(validateTimer); validateTimer=null; }
    }
    camModal.show();
  }catch(e){
    alert("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©.");
    console.error(e);
  }
}
function closeCamera(){
  if(validateTimer){ clearInterval(validateTimer); validateTimer=null; }
  if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; }
  document.getElementById("idFrame").style.borderColor="red";
  greenSince=null; bestShotLock=false;
}
function captureNow(){ captureMode==="ID" ? bestShotCapture() : captureFullNow(); }
function getCropRectInVideoPixels(){
  const v=document.getElementById("camVideo");
  const frame=document.getElementById("idFrame");
  if(!v.videoWidth || !v.videoHeight) return null;
  const vr=v.getBoundingClientRect();
  const fr=frame.getBoundingClientRect();
  const left=Math.max(fr.left,vr.left);
  const top=Math.max(fr.top,vr.top);
  const right=Math.min(fr.right,vr.right);
  const bottom=Math.min(fr.bottom,vr.bottom);
  const wCss=Math.max(0,right-left);
  const hCss=Math.max(0,bottom-top);
  if(wCss<10||hCss<10) return null;
  const sx=(left-vr.left)*(v.videoWidth/vr.width);
  const sy=(top-vr.top)*(v.videoHeight/vr.height);
  const sw=wCss*(v.videoWidth/vr.width);
  const sh=hCss*(v.videoHeight/vr.height);
  const x=Math.max(0,Math.min(v.videoWidth-1,sx));
  const y=Math.max(0,Math.min(v.videoHeight-1,sy));
  const w=Math.max(1,Math.min(v.videoWidth-x,sw));
  const h=Math.max(1,Math.min(v.videoHeight-y,sh));
  return {x,y,w,h};
}
function analyzeROI_lightSharp(data,w,h){
  let sum=0,count=0;
  const gray=new Uint8ClampedArray(w*h);
  for(let i=0,j=0;i<data.length;i+=4,j++){
    const g=(data[i]*0.299+data[i+1]*0.587+data[i+2]*0.114)|0;
    gray[j]=g; sum+=g; count++;
  }
  const mean=sum/count;
  let lapSum=0;
  for(let y=1;y<h-1;y++){
    for(let x=1;x<w-1;x++){
      const c=gray[y*w+x];
      const lap=Math.abs((gray[(y-1)*w+x]+gray[(y+1)*w+x]+gray[y*w+(x-1)]+gray[y*w+(x+1)])-4*c);
      lapSum+=lap;
    }
  }
  const blurScore = lapSum/((w-2)*(h-2));
  return {mean, blurScore};
}
function analyzeLightSharpFastFromVideoROI(){
  const v=document.getElementById("camVideo");
  const roi=getCropRectInVideoPixels();
  if(!roi) return null;
  const testW=220;
  const testH=Math.max(1,Math.round(testW*(roi.h/roi.w)));
  const c=document.createElement("canvas");
  c.width=testW; c.height=testH;
  const ctx=c.getContext("2d",{willReadFrequently:true});
  ctx.drawImage(v,roi.x,roi.y,roi.w,roi.h,0,0,testW,testH);
  const img=ctx.getImageData(0,0,testW,testH);
  return analyzeROI_lightSharp(img.data,testW,testH);
}
function validateFrameFast(){
  if(captureMode!=="ID") return;
  const frame=document.getElementById("idFrame");
  const hint=document.getElementById("camHint");
  const st=analyzeLightSharpFastFromVideoROI();
  if(!st) return;
  const okLight=st.mean>60 && st.mean<205;
  const okSharp=st.blurScore>20;
  const ok=okLight && okSharp;
  frame.style.borderColor= ok ? "lime" : "red";
  if(ok){
    hint.textContent="âœ… Ù…Ù…ØªØ§Ø² â€” Ø³ÙŠØªÙ… Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹";
    if(greenSince===null) greenSince=performance.now();
    autoCaptureTick();
  }else{
    greenSince=null;
    hint.textContent = !okLight ? "âš ï¸ Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨Ø©" : "âš ï¸ Ù…Ùˆ ÙˆØ§Ø¶Ø­ â€” Ø«Ø¨Ù‘Øª ÙŠØ¯Ùƒ";
  }
}
function autoCaptureTick(){
  if(bestShotLock) return;
  const now=performance.now();
  const needGreenMs=260, cooldownMs=900;
  if(greenSince===null) return;
  if(now-greenSince<needGreenMs) return;
  if(now-lastAuto<cooldownMs) return;
  lastAuto=now;
  bestShotCapture();
}
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function grabCroppedFrameWithScore(){
  const v=document.getElementById("camVideo");
  const roi=getCropRectInVideoPixels();
  if(!roi) return null;
  const canvas=document.createElement("canvas");
  canvas.width=Math.max(1,Math.round(roi.w));
  canvas.height=Math.max(1,Math.round(roi.h));
  const ctx=canvas.getContext("2d",{willReadFrequently:true});
  ctx.drawImage(v,roi.x,roi.y,roi.w,roi.h,0,0,canvas.width,canvas.height);
  const testW=240;
  const testH=Math.max(1,Math.round(testW*(canvas.height/canvas.width)));
  const c2=document.createElement("canvas");
  c2.width=testW; c2.height=testH;
  const x2=c2.getContext("2d",{willReadFrequently:true});
  x2.drawImage(canvas,0,0,testW,testH);
  const img=x2.getImageData(0,0,testW,testH);
  const st=analyzeROI_lightSharp(img.data,testW,testH);
  const dataUrl=canvas.toDataURL("image/jpeg",0.92);
  return {dataUrl, score: st.blurScore};
}
async function bestShotCapture(){
  if(bestShotLock) return;
  bestShotLock=true;
  try{
    const shots=[];
    for(let i=0;i<3;i++){
      const s=grabCroppedFrameWithScore();
      if(s) shots.push(s);
      await sleep(110);
    }
    if(!shots.length) throw new Error("no shots");
    shots.sort((a,b)=>b.score-a.score);
    await saveDataUrlToInput(shots[0].dataUrl);
    camModal.hide();
    closeCamera();
  }catch(e){
    console.error(e);
    alert("ØµØ§Ø± Ø®Ø·Ø£ Ø¨Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·. Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.");
    bestShotLock=false;
  }
}
async function captureFullNow(){
  const v=document.getElementById("camVideo");
  if(!v.videoWidth) return;
  const c=document.createElement("canvas");
  c.width=v.videoWidth; c.height=v.videoHeight;
  c.getContext("2d").drawImage(v,0,0,c.width,c.height);
  await saveDataUrlToInput(c.toDataURL("image/jpeg",0.9));
  camModal.hide();
  closeCamera();
}
async function saveDataUrlToInput(dataUrl){
  const blob=await (await fetch(dataUrl)).blob();
  const file=new File([blob],"camera.jpg",{type:"image/jpeg"});
  const dt=new DataTransfer();
  dt.items.add(file);
  const input=document.getElementById(targetInputId);
  input.files=dt.files;
  const prev=document.getElementById(targetInputId+"Preview");
  if(prev){ prev.src=URL.createObjectURL(file); prev.classList.remove("d-none"); }
}
/* =========================
   PDF: 8.7Ã—5.3 cm + safe margin (no PDF Arabic text)
========================= */
const { jsPDF } = window.jspdf;
const CM=28.35;
const SAFE_MARGIN=2*CM;
const ID_W=8.7*CM;
const ID_H=5.3*CM;
const GAP_DEFAULT=20;
const TOP_OFFSET=3.8*CM;
async function loadImageDataForPDF(file){
  const dataUrl = await new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=e=>res(e.target.result);
    r.onerror=rej;
    r.readAsDataURL(file);
  });
  const img = await new Promise((res,rej)=>{
    const i=new Image();
    i.onload=()=>res(i);
    i.onerror=rej;
    i.src=dataUrl;
  });
  const c=document.createElement("canvas");
  const ctx=c.getContext("2d");
  const maxW=2000;
  const scale=Math.min(1,maxW/img.width);
  c.width=Math.round(img.width*scale);
  c.height=Math.round(img.height*scale);
  ctx.drawImage(img,0,0,c.width,c.height);
  return {dataUrl:c.toDataURL("image/jpeg",0.9), format:"JPEG"};
}
function drawContainPDF(pdf, dataUrl, format, x,y,w,h){
  const p=pdf.getImageProperties(dataUrl);
  const s=Math.min(w/p.width,h/p.height);
  const nw=p.width*s, nh=p.height*s;
  pdf.addImage(dataUrl,format,x+(w-nw)/2,y+(h-nh)/2,nw,nh);
}
async function addIDPage(pdf, faceFile, backFile){
  const face=await loadImageDataForPDF(faceFile);
  const back=await loadImageDataForPDF(backFile);
  pdf.addPage("a4","p");
  const pageW=pdf.internal.pageSize.getWidth();
  const safeW=pageW-(SAFE_MARGIN*2);
  let gap=GAP_DEFAULT;
  if((ID_W*2+gap)>safeW) gap=Math.max(8,safeW-(ID_W*2));
  const needW=ID_W*2+gap;
  const startX=SAFE_MARGIN+(safeW-needW)/2;
  const startY=TOP_OFFSET;
  drawContainPDF(pdf,face.dataUrl,face.format,startX,startY,ID_W,ID_H);
  drawContainPDF(pdf,back.dataUrl,back.format,startX+ID_W+gap,startY,ID_W,ID_H);
}
async function addSingleImagePage(pdf,file){
  const d=await loadImageDataForPDF(file);
  pdf.addPage("a4","p");
  const pageW=pdf.internal.pageSize.getWidth();
  const pageH=pdf.internal.pageSize.getHeight();
  drawContainPDF(pdf,d.dataUrl,d.format,SAFE_MARGIN,SAFE_MARGIN,pageW-2*SAFE_MARGIN,pageH-2*SAFE_MARGIN);
}
function collectWivesInfo(){
  if(maritalStatus.value!=="married") return [];
  const n=Math.max(1,Number(wivesCount.value||1));
  const arr=[];
  for(let i=1;i<=n;i++){
    arr.push({
      index:i,
      name:(document.getElementById(`wifeName_${i}`)?.value||"").trim(),
      isEmployee:(document.getElementById(`wifeEmp_${i}`)?.value||"")
    });
  }
  return arr;
}
function collectChildrenNames(){
  if(maritalStatus.value!=="married") return [];
  const n=Math.max(0,Number(childrenCount.value||0));
  const arr=[];
  for(let i=1;i<=n;i++) arr.push((document.getElementById(`childName_${i}`)?.value||"").trim());
  return arr;
}
/* =========================
   Ø¥Ø±Ø³Ø§Ù„ Ø¢Ù…Ù† Ù„Ù„Ø´ÙŠØª (Apps Script submitForm)
========================= */
function showSheetStatus(type,msg){
  const el=document.getElementById("sheetStatus");
  el.classList.remove("d-none","alert-success","alert-danger","alert-info");
  el.classList.add("alert",type);
  el.textContent=msg;
}
async function sendToGoogleSheetSecure(){
  const loginId = localStorage.getItem("dar_login_id") || "";
  const loginName = localStorage.getItem("dar_login_name") || "";
  const body = new URLSearchParams();
  body.set("action","submitForm");
  body.set("loginId", loginId);
  body.set("loginName", loginName);
  body.set("employeeName", employeeName.value.trim());
  body.set("birthPlace", birthPlace.value.trim());
  body.set("birthDate", birthDate.value || "");
  body.set("phone", phone.value.trim());
  body.set("badgeNumber", badgeNumber.value.trim());
  body.set("education", education.value || "");
  body.set("specialty", specialty.value.trim());
  body.set("address", address.value.trim());
  body.set("maritalStatus", maritalStatus.value || "");
  const married = maritalStatus.value==="married";
  body.set("wivesCount", married ? String(wivesCount.value||"1") : "");
  body.set("wivesInfo", JSON.stringify(collectWivesInfo()));
  body.set("childrenMother", married ? childrenMother.value.trim() : "");
  body.set("childrenCount", married ? String(childrenCount.value||"0") : "");
  body.set("childrenNames", JSON.stringify(collectChildrenNames()));
  body.set("hasResidence", hasResidence.checked ? "1" : "0");
  body.set("hasBadge", hasBadge.checked ? "1" : "0");
  body.set("hasCertificate", hasCertificate.checked ? "1" : "0");
  const res = await fetch(SCRIPT_URL, { method:"POST", body });
  const txt = (await res.text()).trim();
  return txt === "OK";
}
/* =========================
   Validate + Submit
========================= */
function validateBasics(){
  const name = employeeName.value.trim();
  if(!name){ alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…"); return false; }
  if(!isQuadName(name)){ alert("Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ø¨Ø§Ø¹ÙŠ (4 ÙƒÙ„Ù…Ø§Øª)"); return false; }
  if(!empFace.files[0] || !empBack.files[0]){ alert("Ø§Ø±ÙØ¹ ÙˆØ¬Ù‡/Ø¸Ù‡Ø± Ø§Ù„ÙˆØ·Ù†ÙŠØ©"); return false; }
  if(!resFace.files[0] || !resBack.files[0]){
  alert("Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³ÙƒÙ† Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© (ÙˆØ¬Ù‡ ÙˆØ¸Ù‡Ø±)");
  return false;
}

  if(hasBadge.checked && (!badgeFace.files[0] || !badgeBack.files[0])){ alert("Ø§Ø±ÙØ¹ ÙˆØ¬Ù‡/Ø¸Ù‡Ø± Ø¨Ø§Ø¬ Ø§Ù„Ø¹ØªØ¨Ø©"); return false; }
  if(maritalStatus.value==="married"){
    const wCount=Math.max(1,Number(wivesCount.value||1));
    for(let i=1;i<=wCount;i++){
      const wn=(document.getElementById(`wifeName_${i}`)?.value||"").trim();
      const we=(document.getElementById(`wifeEmp_${i}`)?.value||"");
      if(!wn){ alert(`Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø²ÙˆØ¬Ø© ${i}`); return false; }
      if(!we){ alert(`Ø­Ø¯Ø¯ Ù…ÙˆØ¸ÙØ© Ù„Ù„Ø²ÙˆØ¬Ø© ${i}`); return false; }
      if(!document.getElementById(`wifeFace_${i}`)?.files[0] || !document.getElementById(`wifeBack_${i}`)?.files[0]){
        alert(`Ø§Ø±ÙØ¹ ÙˆØ¬Ù‡/Ø¸Ù‡Ø± Ù‡ÙˆÙŠØ© Ø§Ù„Ø²ÙˆØ¬Ø© ${i}`); return false;
      }
    }
    const cCount=Math.max(0,Number(childrenCount.value||0));
    if(cCount>0){
      if(!childrenMother.value.trim()){ alert("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø£Ù… Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡"); return false; }
      const names=collectChildrenNames().filter(Boolean);
      if(names.length<cCount){ alert("Ø§Ø¯Ø®Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø¯Ø¯"); return false; }
      for(let i=1;i<=cCount;i++){
        if(!document.getElementById(`childFace_${i}`)?.files[0] || !document.getElementById(`childBack_${i}`)?.files[0]){
          alert(`Ø§Ø±ÙØ¹ ÙˆØ¬Ù‡/Ø¸Ù‡Ø± Ù‡ÙˆÙŠØ© Ø§Ù„Ø·ÙÙ„ ${i}`); return false;
        }
      }
    }
  }
  if(hasCertificate.checked && !certificateFile.files[0]){
    alert("Ø§Ø±ÙØ¹ Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØªØ®Ø±Ø¬"); return false;
  }
  return true;
}
async function generatePDF(){
  const name = employeeName.value.trim();
  const pdf=new jsPDF({unit:"px", format:"a4"});
  await addIDPage(pdf, empFace.files[0], empBack.files[0]);
  if(hasResidence.checked) await addIDPage(pdf, resFace.files[0], resBack.files[0]);
  if(hasBadge.checked) await addIDPage(pdf, badgeFace.files[0], badgeBack.files[0]);
  if(maritalStatus.value==="married"){
    const wCount=Math.max(1,Number(wivesCount.value||1));
    for(let i=1;i<=wCount;i++){
      await addIDPage(pdf, document.getElementById(`wifeFace_${i}`).files[0], document.getElementById(`wifeBack_${i}`).files[0]);
    }
    const cCount=Math.max(0,Number(childrenCount.value||0));
    for(let i=1;i<=cCount;i++){
      await addIDPage(pdf, document.getElementById(`childFace_${i}`).files[0], document.getElementById(`childBack_${i}`).files[0]);
    }
  }
  if(hasCertificate.checked){
    await addSingleImagePage(pdf, certificateFile.files[0]);
  }
  if(pdf.getNumberOfPages()>1) pdf.deletePage(1);
  pdf.save(name.replace(/\s+/g,"_") + "_documents.pdf");
}
async function submitAll(){
  if(!validateBasics()) return;

  try{
    showSheetStatus("alert-info","Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...");

    const ok = await sendToGoogleSheetSecure(); // â¬…ï¸ Ø£ÙˆÙ„Ø§Ù‹ Ø§Ù„Ø´ÙŠØª

    if(!ok){
      showSheetStatus("alert-danger","ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Google Sheet");
      return;
    }

    showSheetStatus("alert-success","ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ… Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF...");
    
    await generatePDF(); // â¬…ï¸ Ø¨Ø¹Ø¯Ù‡Ø§ PDF

    showSheetStatus("alert-success","ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ¥Ù†Ø´Ø§Ø¡ PDF Ø¨Ù†Ø¬Ø§Ø­ âœ…");

  }catch(e){
    console.error(e);
    showSheetStatus("alert-danger","ØµØ§Ø± Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹");
  }
}

}
/* =========================
   Preview binding for new inputs created dynamically
========================= */
function bindPreview(id){
  const input = document.getElementById(id);
  if(!input) return;
  input.addEventListener("change", ()=>{
    const file = input.files && input.files[0];
    const prev = document.getElementById(id+"Preview");
    if(file && prev){
      prev.src = URL.createObjectURL(file);
      prev.classList.remove("d-none");
    }
  });
  function showLoader(){
  document.getElementById("loaderPage").classList.remove("d-none");
}
function hideLoader(){
  document.getElementById("loaderPage").classList.add("d-none");
}

</script>
  <!-- ===== LOADER ===== -->
<div id="loaderPage" class="d-none"
     style="position:fixed;inset:0;z-index:9999;
     background:rgba(255,255,255,.9);
     display:flex;align-items:center;justify-content:center;">
  <div class="text-center">
    <div class="spinner-border text-primary" style="width:4rem;height:4rem"></div>
    <div class="mt-3 fw-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  </div>
</div>
</body>
</html>



