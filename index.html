const SPREADSHEET_ID = "10RwjvXjpnrxG-I7Twztb4hDsxCxnHLEvu3c52sSc1LE";
const USERS_SHEET = "Users"; // يحتوي UserID + NameVariant
const FORM_SHEET  = "Form";  // بيانات الاستمارة

function doGet(e){
  return ContentService.createTextOutput("Web App is running OK");
}

function normName(s){
  return (s || "")
    .toString()
    .trim()
    .replace(/\s+/g, " ")
    .toLowerCase();
}

function doPost(e){
  try{
    const action = (e.parameter.action || "").toString();

    if(action === "login"){
      return handleLogin_(e);
    }

    if(action === "submitForm"){
      return handleSubmitForm_(e);
    }

    return ContentService.createTextOutput("ERR: Unknown action");
  }catch(err){
    return ContentService.createTextOutput("ERR: " + err);
  }
}

function handleLogin_(e){
  const id = (e.parameter.id || "").toString().trim();
  const name = normName(e.parameter.name);

  if(!id || !name){
    return ContentService.createTextOutput("ERR: Missing id/name");
  }

  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sh = ss.getSheetByName(USERS_SHEET);
  if(!sh) return ContentService.createTextOutput("ERR: Users sheet not found");

  const values = sh.getDataRange().getValues(); // [UserID, NameVariant]
  // توقع أول صف هيدر (UserID, NameVariant)
  for(let i=1;i<values.length;i++){
    const rowId = (values[i][0] || "").toString().trim();
    const rowName = normName(values[i][1]);
    if(rowId === id && rowName === name){
      // رجّع اسم “مرجعي” (اختياري)
      return ContentService.createTextOutput("OK");
    }
  }

  return ContentService.createTextOutput("NO");
}

function handleSubmitForm_(e){
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sh = ss.getSheetByName(FORM_SHEET) || ss.insertSheet(FORM_SHEET);

  if (sh.getLastRow() === 0) {
    sh.appendRow([
      "Timestamp",
      "LoginID","LoginName",
      "EmployeeName","BirthPlace","BirthDate","Phone","BadgeNumber",
      "Education","Specialty","Address",
      "MaritalStatus","WivesCount","WivesInfoJSON",
      "ChildrenMother","ChildrenCount","ChildrenNamesJSON",
      "HasResidence","HasBadge","HasCertificate"
    ]);
  }

  const p = e.parameter;

  sh.appendRow([
    new Date(),
    p.loginId || "",
    p.loginName || "",
    p.employeeName || "",
    p.birthPlace || "",
    p.birthDate || "",
    p.phone || "",
    p.badgeNumber || "",
    p.education || "",
    p.specialty || "",
    p.address || "",
    p.maritalStatus || "",
    p.wivesCount || "",
    p.wivesInfo || "[]",
    p.childrenMother || "",
    p.childrenCount || "",
    p.childrenNames || "[]",
    p.hasResidence || "0",
    p.hasBadge || "0",
    p.hasCertificate || "0"
  ]);

  return ContentService.createTextOutput("OK");
}
