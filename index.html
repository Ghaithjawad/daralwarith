<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>استمارة تحديث بيانات موظفي دار الوارث</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --main:#1aa6a6;
  --dark:#148c8c;
  --border:#d9eeee;
  --text:#0f3f3f;
}
body{
  font-family:"Segoe UI",Tahoma,sans-serif;
  color:var(--text);
  background-image:url("background.png");
  background-repeat:repeat;
  background-size:420px 420px;
  background-attachment:fixed;
}
.container{
  background:#ffffff;
  border-radius:22px;
  padding:30px;
  margin:30px auto 25px;
  box-shadow:0 18px 40px rgba(0,0,0,.18);
}
.header{
  background:linear-gradient(135deg,var(--main),var(--dark));
  color:#fff;
  padding:30px;
  border-radius:18px;
  text-align:center;
  margin-bottom:30px;
}
.logo{ max-width:150px; display:block; margin:auto; }
.card{
  border:1px solid var(--border);
  border-radius:16px;
  margin-bottom:22px;
}
.section{
  border:2px dashed var(--main);
  border-radius:14px;
  padding:16px;
  margin-top:14px;
  background:#f9fefe;
}
.check-box{
  border:1.8px solid var(--main);
  border-radius:12px;
  padding:12px 16px;
  background:#f6fdfd;
}
.form-check-input{ width:18px; height:18px; margin-left:10px; }
.form-check-input:checked{ background-color:var(--main); border-color:var(--main); }

button.main-btn{
  background:var(--main);
  border:none;
  padding:16px;
  font-size:18px;
  border-radius:14px;
  color:#fff;
}
button.main-btn:hover{ background:var(--dark); }

.preview-img{
  max-height:180px;
  width:100%;
  object-fit:contain;
  border-radius:12px;
  border:1px solid #e8e8e8;
  background:#fff;
}

/* ===== كاميرا ===== */
.cam-wrap{ position:relative; width:100%; }
#camVideo{ width:100%; border-radius:12px; background:#000; }
.cam-overlay{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  pointer-events:none;
}
.id-frame{
  width:74%;
  aspect-ratio: 8.7 / 5.3;
  border:4px solid red;
  border-radius:14px;
  box-shadow:0 0 0 2000px rgba(0,0,0,.45);
}
#cvDebug{
  position:absolute;
  bottom:10px;
  left:10px;
  background:rgba(0,0,0,.45);
  color:#fff;
  padding:6px 10px;
  border-radius:10px;
  font-size:12px;
  display:none;
}
.footer-note{
  text-align:center;
  margin:14px auto 25px;
  color:#0f3f3f;
  opacity:.85;
  font-weight:600;
}
.small-note{ font-size:.9rem; color:#666; }
</style>
</head>

<body>

<div class="container">

  <div class="header">
    <img src="logo.png" class="logo mb-3" alt="دار الوارث">
    <h4 class="mb-1">استمارة تحديث بيانات موظفي دار الوارث</h4>
    <p class="mb-0">يرجى إدخال البيانات ورفع المستمسكات المطلوبة</p>
  </div>

  <div id="secureWarn" class="alert alert-warning d-none">
    الكاميرا لا تعمل إلا على <b>HTTPS</b> أو <b>localhost</b>. على GitHub Pages راح تشتغل (HTTPS).
  </div>

  <div id="cvWarn" class="alert alert-info d-none">
    جاري تحميل نظام التعرّف الذكي على الهوية… إذا تأخر، جرّب تحديث الصفحة.
  </div>

  <!-- اسم الموظف -->
  <div class="card p-4">
    <label class="fw-bold">اسم الموظف الكامل</label>
    <input type="text" id="employeeName" class="form-control">
  </div>

  <!-- البطاقة الوطنية -->
  <div class="card p-4">
    <h5 class="mb-3">البطاقة الوطنية للموظف</h5>

    <div class="mb-3">
      <label class="fw-bold mb-2 d-block">وجه الهوية</label>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('empFace')">كاميرا</button>
        <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('empFace')">استوديو</button>
      </div>
      <input type="file" id="empFace" class="form-control d-none" accept="image/*">
      <img id="empFacePreview" class="preview-img mt-2 d-none" alt="preview">
    </div>

    <div>
      <label class="fw-bold mb-2 d-block">ظهر الهوية</label>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('empBack')">كاميرا</button>
        <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('empBack')">استوديو</button>
      </div>
      <input type="file" id="empBack" class="form-control d-none" accept="image/*">
      <img id="empBackPreview" class="preview-img mt-2 d-none" alt="preview">
    </div>
  </div>

  <!-- بطاقة السكن -->
  <div class="card p-4">
    <div class="check-box form-check">
      <label class="form-check-label">هل توجد بطاقة سكن؟</label>
      <input class="form-check-input" type="checkbox" id="hasResidence">
    </div>

    <div id="residenceSection" class="section d-none">
      <div class="mb-3">
        <label class="fw-bold mb-2 d-block">وجه بطاقة السكن</label>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('resFace')">كاميرا</button>
          <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('resFace')">استوديو</button>
        </div>
        <input type="file" id="resFace" class="form-control d-none" accept="image/*">
        <img id="resFacePreview" class="preview-img mt-2 d-none" alt="preview">
      </div>

      <div>
        <label class="fw-bold mb-2 d-block">ظهر بطاقة السكن</label>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('resBack')">كاميرا</button>
          <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('resBack')">استوديو</button>
        </div>
        <input type="file" id="resBack" class="form-control d-none" accept="image/*">
        <img id="resBackPreview" class="preview-img mt-2 d-none" alt="preview">
      </div>
    </div>
  </div>

  <!-- متزوج -->
  <div class="card p-4">
    <div class="check-box form-check">
      <label class="form-check-label">هل أنت متزوج؟</label>
      <input class="form-check-input" type="checkbox" id="isMarried">
    </div>

    <div id="wivesSection" class="section d-none">
      <label class="fw-bold">عدد الزوجات</label>
      <input type="number" id="wivesCount" min="1" class="form-control mb-3">
      <div id="wivesUploads"></div>
    </div>
  </div>

  <!-- أطفال -->
  <div class="card p-4">
    <div class="check-box form-check">
      <label class="form-check-label">هل يوجد أطفال؟</label>
      <input class="form-check-input" type="checkbox" id="hasChildren">
    </div>

    <div id="childrenSection" class="section d-none">
      <label class="fw-bold">عدد الأطفال</label>
      <input type="number" id="childrenCount" min="1" class="form-control mb-3">
      <div id="childrenUploads"></div>
    </div>
  </div>

  <!-- التموينية (بدون ذكاء/بدون قص) -->
  <div class="card p-4">
    <div class="check-box form-check">
      <label class="form-check-label">هل توجد بطاقة تموينية؟</label>
      <input class="form-check-input" type="checkbox" id="hasRation">
    </div>

    <div id="rationSection" class="section d-none">
      <label class="fw-bold mb-2 d-block">صورة البطاقة التموينية</label>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('rationFace')">كاميرا</button>
        <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('rationFace')">استوديو</button>
      </div>
      <input type="file" id="rationFace" class="form-control d-none" accept="image/*">
      <img id="rationFacePreview" class="preview-img mt-2 d-none" alt="preview">
    </div>
  </div>

  <!-- الشهادة (بدون ذكاء/بدون قص) -->
  <div class="card p-4">
    <div class="check-box form-check">
      <label class="form-check-label">هل توجد شهادة تخرج؟</label>
      <input class="form-check-input" type="checkbox" id="hasCertificate">
    </div>

    <div id="certificateSection" class="section d-none">
      <label class="fw-bold mb-2 d-block">صورة شهادة التخرج</label>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('certificateFile')">كاميرا</button>
        <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('certificateFile')">استوديو</button>
      </div>
      <input type="file" id="certificateFile" class="form-control d-none" accept="image/*">
      <img id="certificateFilePreview" class="preview-img mt-2 d-none" alt="preview">
    </div>
  </div>

  <button class="w-100 main-btn" onclick="generatePDF()">إرسال وإنشاء ملف PDF</button>

  <div class="mt-3 small-note">
    الوطني + السكن: قصّ ذكي للهوية فقط. التموينية/الشهادة: التقاط عادي.
  </div>

</div>

<div class="footer-note">تطوير شعبة تقنية المعلومات لدار الوارث</div>

<!-- مودال الكاميرا -->
<div class="modal fade" id="camModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">كاميرا</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="closeCamera()"></button>
      </div>

      <div class="modal-body">
        <div class="cam-wrap">
          <video id="camVideo" autoplay playsinline></video>
          <div class="cam-overlay">
            <div id="idFrame" class="id-frame"></div>
          </div>
          <div id="cvDebug"></div>
        </div>
        <div class="mt-2">
          <small class="text-muted" id="camHint">وجّه الهوية داخل الإطار</small>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeCamera()">إغلاق</button>
        <button type="button" class="btn btn-success" id="captureBtn" onclick="captureAction()">التقاط</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- OpenCV.js (للذكاء والدقة في الهوية) -->
<script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady()"></script>

<script>
/* =========================
   A) HTTPS / localhost
========================= */
function isCameraAllowedContext(){
  const isLocalhost = ["localhost","127.0.0.1"].includes(location.hostname);
  return window.isSecureContext || isLocalhost;
}
(function(){
  document.getElementById("secureWarn").classList.toggle("d-none", isCameraAllowedContext());
})();

/* =========================
   B) Studio + preview
========================= */
function openStudio(inputId){
  const el = document.getElementById(inputId);
  if(el) el.click();
}
function bindPreview(inputId){
  const input = document.getElementById(inputId);
  if(!input) return;
  input.addEventListener("change", ()=>{
    const file = input.files && input.files[0];
    const prev = document.getElementById(inputId+"Preview");
    if(file && prev){
      prev.src = URL.createObjectURL(file);
      prev.classList.remove("d-none");
    }
  });
}
["empFace","empBack","resFace","resBack","rationFace","certificateFile"].forEach(bindPreview);

/* =========================
   C) Sections
========================= */
hasResidence.onchange = ()=> residenceSection.classList.toggle("d-none", !hasResidence.checked);
isMarried.onchange    = ()=> wivesSection.classList.toggle("d-none", !isMarried.checked);
hasChildren.onchange  = ()=> childrenSection.classList.toggle("d-none", !hasChildren.checked);
hasRation.onchange    = ()=> rationSection.classList.toggle("d-none", !hasRation.checked);
hasCertificate.onchange = ()=> certificateSection.classList.toggle("d-none", !hasCertificate.checked);

/* =========================
   D) Dynamic wife/child (عادي بدون ذكاء)
========================= */
function makeUploadBlock(prefix, i){
  const faceId = `${prefix}Face_${i}`;
  const backId = `${prefix}Back_${i}`;
  const title = (prefix==="wife") ? `زوجة ${i}` : `طفل ${i}`;

  return `
    <div class="mb-3 p-3 rounded border bg-white">
      <strong class="d-block mb-2">${title}</strong>

      <div class="mb-2">
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('${faceId}')">كاميرا (وجه)</button>
          <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('${faceId}')">استوديو (وجه)</button>
        </div>
        <input type="file" id="${faceId}" class="form-control d-none ${prefix}-face" accept="image/*">
        <img id="${faceId}Preview" class="preview-img mt-2 d-none" alt="preview">
      </div>

      <div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('${backId}')">كاميرا (ظهر)</button>
          <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('${backId}')">استوديو (ظهر)</button>
        </div>
        <input type="file" id="${backId}" class="form-control d-none ${prefix}-back" accept="image/*">
        <img id="${backId}Preview" class="preview-img mt-2 d-none" alt="preview">
      </div>
    </div>
  `;
}
function bindDynamicPreviews(prefix, n){
  for(let i=1;i<=n;i++){
    bindPreview(`${prefix}Face_${i}`);
    bindPreview(`${prefix}Back_${i}`);
  }
}
wivesCount.oninput = ()=>{
  const n = Number(wivesCount.value || 0);
  wivesUploads.innerHTML = "";
  for(let i=1;i<=n;i++) wivesUploads.innerHTML += makeUploadBlock("wife", i);
  bindDynamicPreviews("wife", n);
};
childrenCount.oninput = ()=>{
  const n = Number(childrenCount.value || 0);
  childrenUploads.innerHTML = "";
  for(let i=1;i<=n;i++) childrenUploads.innerHTML += makeUploadBlock("child", i);
  bindDynamicPreviews("child", n);
};

/* =========================
   E) Smart ID only for national + residence
========================= */
const SMART_ID_INPUTS = new Set(["empFace","empBack","resFace","resBack"]); // فقط هذني
function isSmartIdInput(inputId){ return SMART_ID_INPUTS.has(inputId); }

/* =========================
   F) OpenCV readiness
========================= */
let cvReady = false;
function onOpenCvReady(){
  // بعض الأحيان cv.onload يسبق تهيئة cv.Mat
  const t = setInterval(()=>{
    if(window.cv && cv.Mat){
      cvReady = true;
      document.getElementById("cvWarn").classList.add("d-none");
      clearInterval(t);
    }
  }, 80);
}

/* =========================
   G) Camera controller
========================= */
let camStream = null;
let targetInputId = null;
let camModal = null;
let validateTimer = null;
let stableSince = null;
let lastFoundQuad = null;
let currentMode = "NORMAL"; // "SMART_ID" | "NORMAL"

async function openCameraFor(inputId){
  if(!isCameraAllowedContext()){
    alert("الكاميرا ما تشتغل إلا على HTTPS أو localhost.\nعلى GitHub Pages راح تشتغل تلقائياً.");
    return;
  }

  targetInputId = inputId;
  currentMode = isSmartIdInput(inputId) ? "SMART_ID" : "NORMAL";

  // لو Smart لازم OpenCV
  if(currentMode === "SMART_ID" && !cvReady){
    document.getElementById("cvWarn").classList.remove("d-none");
  }

  if(!camModal) camModal = new bootstrap.Modal(document.getElementById("camModal"));

  try{
    camStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode:"environment" },
      audio:false
    });

    const v = document.getElementById("camVideo");
    v.srcObject = camStream;

    // UI mode
    const frameEl = document.getElementById("idFrame");
    frameEl.style.display = (currentMode === "SMART_ID") ? "block" : "none";

    document.getElementById("camHint").textContent =
      (currentMode === "SMART_ID")
        ? "وجّه الهوية داخل الإطار (يصبح أخضر عند اكتشاف الهوية)"
        : "التقاط عادي (للشهادة/التموينية وغيرها)";

    document.getElementById("captureBtn").disabled = (currentMode === "SMART_ID"); // يتفعل عند الاخضر
    lastFoundQuad = null;
    stableSince = null;

    camModal.show();

    if(validateTimer) clearInterval(validateTimer);
    validateTimer = setInterval(()=>tickValidate(), 140);

  }catch(e){
    alert("تعذر تشغيل الكاميرا. تأكد من إعطاء الصلاحية.");
    console.error(e);
  }
}

function closeCamera(){
  if(validateTimer){ clearInterval(validateTimer); validateTimer=null; }
  if(camStream){
    camStream.getTracks().forEach(t=>t.stop());
    camStream = null;
  }
  document.getElementById("idFrame").style.borderColor = "red";
  document.getElementById("captureBtn").disabled = (currentMode === "SMART_ID");
  stableSince = null;
  lastFoundQuad = null;
}

function captureAction(){
  if(currentMode === "SMART_ID"){
    // قص ذكي للهوية فقط
    captureSmartIdNow();
  }else{
    // التقاط كامل بدون قص
    captureNormalNow();
  }
}

/* =========================
   H) SMART detection (OpenCV): find a 4-point card with correct aspect
========================= */
const CARD_ASPECT = 8.7 / 5.3; // ~1.6415
const ASPECT_TOL  = 0.18;      // سماحية
const MIN_AREA_FRAC = 0.30;    // لازم تغطي جزء من الإطار

function tickValidate(){
  if(currentMode !== "SMART_ID"){
    // normal mode: nothing to validate
    return;
  }

  const frameEl = document.getElementById("idFrame");
  const hint = document.getElementById("camHint");
  const capBtn = document.getElementById("captureBtn");

  if(!cvReady){
    frameEl.style.borderColor = "red";
    capBtn.disabled = true;
    hint.textContent = "⏳ جاري تحميل نظام التعرف…";
    return;
  }

  const v = document.getElementById("camVideo");
  if(!v.videoWidth) return;

  // نقرأ ROI حسب إطار الـ DOM ثم نشتغل عليه
  const roi = getFrameRoiInVideoPixels();
  if(!roi) return;

  const quad = detectCardQuadInROI(v, roi);
  if(quad){
    frameEl.style.borderColor = "lime";
    capBtn.disabled = false;
    hint.textContent = "✅ تم اكتشاف الهوية — ثبّت لحظة للتقاط تلقائي";

    lastFoundQuad = { roi, quad }; // quad نقاط داخل ROI (px)

    // auto capture بعد ثبات قصير
    const now = performance.now();
    if(stableSince === null) stableSince = now;

    // أسرع بس ما يكون مزعج: 350ms ثبات
    if(now - stableSince > 350){
      stableSince = null;
      captureSmartIdNow(); // تلقائي
    }
  }else{
    frameEl.style.borderColor = "red";
    capBtn.disabled = true;
    hint.textContent = "❌ لم يتم اكتشاف الهوية — قرّب الهوية وخليها داخل الإطار وبإضاءة جيدة";
    stableSince = null;
    lastFoundQuad = null;
  }
}

function getFrameRoiInVideoPixels(){
  const v = document.getElementById("camVideo");
  const frame = document.getElementById("idFrame");
  if(!v.videoWidth || !v.videoHeight) return null;

  const vr = v.getBoundingClientRect();
  const fr = frame.getBoundingClientRect();

  const left   = Math.max(fr.left, vr.left);
  const top    = Math.max(fr.top, vr.top);
  const right  = Math.min(fr.right, vr.right);
  const bottom = Math.min(fr.bottom, vr.bottom);

  const wCss = Math.max(0, right - left);
  const hCss = Math.max(0, bottom - top);
  if(wCss < 10 || hCss < 10) return null;

  const sx = (left - vr.left) * (v.videoWidth  / vr.width);
  const sy = (top  - vr.top ) * (v.videoHeight / vr.height);
  const sw = wCss * (v.videoWidth  / vr.width);
  const sh = hCss * (v.videoHeight / vr.height);

  const x = Math.max(0, Math.min(v.videoWidth - 1, sx));
  const y = Math.max(0, Math.min(v.videoHeight - 1, sy));
  const w = Math.max(1, Math.min(v.videoWidth  - x, sw));
  const h = Math.max(1, Math.min(v.videoHeight - y, sh));

  return { x, y, w, h };
}

function detectCardQuadInROI(videoEl, roi){
  // نرسم ROI على canvas صغير لتسريع
  const targetW = 420;
  const scale = targetW / roi.w;
  const targetH = Math.max(1, Math.round(roi.h * scale));

  const canvas = document.createElement("canvas");
  canvas.width = targetW;
  canvas.height = targetH;
  const ctx = canvas.getContext("2d", { willReadFrequently:true });
  ctx.drawImage(videoEl, roi.x, roi.y, roi.w, roi.h, 0, 0, targetW, targetH);

  let src = cv.imread(canvas);
  let gray = new cv.Mat();
  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

  // تحسين بسيط للإضاءة
  let blur = new cv.Mat();
  cv.GaussianBlur(gray, blur, new cv.Size(5,5), 0);

  // Edge
  let edges = new cv.Mat();
  cv.Canny(blur, edges, 60, 160);

  // أغلاق فجوات الحواف
  let kernel = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(5,5));
  let closed = new cv.Mat();
  cv.morphologyEx(edges, closed, cv.MORPH_CLOSE, kernel);

  // Contours
  let contours = new cv.MatVector();
  let hierarchy = new cv.Mat();
  cv.findContours(closed, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

  let best = null;
  let bestArea = 0;

  const roiArea = targetW * targetH;

  for(let i=0;i<contours.size();i++){
    const cnt = contours.get(i);
    const area = cv.contourArea(cnt);
    if(area < roiArea * MIN_AREA_FRAC) { cnt.delete(); continue; }

    const peri = cv.arcLength(cnt, true);
    const approx = new cv.Mat();
    cv.approxPolyDP(cnt, approx, 0.02 * peri, true);

    if(approx.rows === 4){
      // aspect by boundingRect (سريع)
      const rect = cv.boundingRect(approx);
      const aspect = rect.width / rect.height;
      const a1 = aspect;
      const a2 = 1/aspect;

      const okAspect = (Math.abs(a1 - CARD_ASPECT) < ASPECT_TOL) || (Math.abs(a2 - CARD_ASPECT) < ASPECT_TOL);
      if(okAspect && area > bestArea){
        bestArea = area;
        best = approx.clone();
      }
    }

    approx.delete();
    cnt.delete();
  }

  // cleanup
  src.delete(); gray.delete(); blur.delete(); edges.delete(); kernel.delete(); closed.delete(); contours.delete(); hierarchy.delete();

  if(!best) return null;

  // best نقاط داخل canvas المصغر (targetW,targetH) => نرجعها بإحداثيات ROI الأصلية
  const pts = [];
  for(let r=0;r<4;r++){
    const x = best.intPtr(r,0)[0];
    const y = best.intPtr(r,0)[1];
    pts.push({x, y});
  }
  best.delete();

  // ترتيب النقاط (tl,tr,br,bl)
  const ordered = orderQuadPoints(pts);

  // تحويل من target -> roi px
  const invScale = roi.w / targetW;
  const quadInRoi = ordered.map(p=>({ x: p.x * invScale, y: p.y * invScale }));

  return quadInRoi;
}

function orderQuadPoints(pts){
  // sum and diff technique
  const sum = pts.map(p=>p.x+p.y);
  const diff = pts.map(p=>p.x-p.y);

  const tl = pts[sum.indexOf(Math.min(...sum))];
  const br = pts[sum.indexOf(Math.max(...sum))];
  const tr = pts[diff.indexOf(Math.max(...diff))];
  const bl = pts[diff.indexOf(Math.min(...diff))];

  return [tl,tr,br,bl];
}

/* =========================
   I) Capture SMART: perspective crop to exact 8.7:5.3
========================= */
async function captureSmartIdNow(){
  if(!lastFoundQuad) return;

  const v = document.getElementById("camVideo");
  const { roi, quad } = lastFoundQuad; // quad points inside roi (px)

  // output size ثابت للهوية (يناسب PDF)
  const outW = 870;
  const outH = 530;

  // نرسم ROI كامل أولاً
  const roiCanvas = document.createElement("canvas");
  roiCanvas.width = Math.round(roi.w);
  roiCanvas.height = Math.round(roi.h);
  const rctx = roiCanvas.getContext("2d", { willReadFrequently:true });
  rctx.drawImage(v, roi.x, roi.y, roi.w, roi.h, 0, 0, roiCanvas.width, roiCanvas.height);

  // OpenCV perspective transform
  const srcMat = cv.imread(roiCanvas);
  const dstMat = new cv.Mat();

  const srcTri = cv.matFromArray(4, 1, cv.CV_32FC2, [
    quad[0].x, quad[0].y,
    quad[1].x, quad[1].y,
    quad[2].x, quad[2].y,
    quad[3].x, quad[3].y
  ]);

  const dstTri = cv.matFromArray(4, 1, cv.CV_32FC2, [
    0, 0,
    outW, 0,
    outW, outH,
    0, outH
  ]);

  const M = cv.getPerspectiveTransform(srcTri, dstTri);
  const dsize = new cv.Size(outW, outH);
  cv.warpPerspective(srcMat, dstMat, M, dsize, cv.INTER_LINEAR, cv.BORDER_REPLICATE);

  const outCanvas = document.createElement("canvas");
  outCanvas.width = outW;
  outCanvas.height = outH;
  cv.imshow(outCanvas, dstMat);

  // cleanup
  srcMat.delete(); dstMat.delete(); srcTri.delete(); dstTri.delete(); M.delete();

  const dataUrl = outCanvas.toDataURL("image/jpeg", 0.92);
  await saveDataUrlToInput(dataUrl);

  // close
  camModal.hide();
  closeCamera();
}

/* =========================
   J) Capture NORMAL: full frame (no crop)
========================= */
async function captureNormalNow(){
  const v = document.getElementById("camVideo");
  if(!v.videoWidth) return;

  const canvas = document.createElement("canvas");
  canvas.width = v.videoWidth;
  canvas.height = v.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(v,0,0,canvas.width,canvas.height);

  const dataUrl = canvas.toDataURL("image/jpeg", 0.9);
  await saveDataUrlToInput(dataUrl);

  camModal.hide();
  closeCamera();
}

/* =========================
   K) save to input + preview
========================= */
async function saveDataUrlToInput(dataUrl){
  const blob = await (await fetch(dataUrl)).blob();
  const file = new File([blob], "camera.jpg", {type:"image/jpeg"});
  const dt = new DataTransfer();
  dt.items.add(file);

  const input = document.getElementById(targetInputId);
  input.files = dt.files;

  const prev = document.getElementById(targetInputId+"Preview");
  if(prev){
    prev.src = URL.createObjectURL(file);
    prev.classList.remove("d-none");
  }
}

/* =========================
   L) PDF (8.7×5.3) + no Arabic text + safe margins
========================= */
const { jsPDF } = window.jspdf;
const CM = 28.35;
const SAFE_MARGIN = 2 * CM;
const ID_W = 8.7 * CM;
const ID_H = 5.3 * CM;
const GAP_DEFAULT = 20;
const TOP_OFFSET = 3.8 * CM;

async function loadImageDataForPDF(file){
  const dataUrl = await new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=e=>resolve(e.target.result);
    r.onerror=reject;
    r.readAsDataURL(file);
  });

  const img = await new Promise((resolve,reject)=>{
    const i=new Image();
    i.onload=()=>resolve(i);
    i.onerror=reject;
    i.src=dataUrl;
  });

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  const maxW = 2000;
  const scale = Math.min(1, maxW / img.width);

  canvas.width = Math.round(img.width * scale);
  canvas.height = Math.round(img.height * scale);
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

  return { dataUrl: canvas.toDataURL("image/jpeg", 0.9), format: "JPEG" };
}

function drawContainPDF(pdf, dataUrl, format, x, y, w, h){
  const p = pdf.getImageProperties(dataUrl);
  const s = Math.min(w/p.width, h/p.height);
  const nw = p.width*s, nh = p.height*s;
  const nx = x + (w-nw)/2;
  const ny = y + (h-nh)/2;
  pdf.addImage(dataUrl, format, nx, ny, nw, nh);
}

async function addIDPage(pdf, faceFile, backFile){
  const face = await loadImageDataForPDF(faceFile);
  const back = await loadImageDataForPDF(backFile);

  pdf.addPage("a4","p");

  const pageW = pdf.internal.pageSize.getWidth();
  const safeW = pageW - (SAFE_MARGIN * 2);

  let gap = GAP_DEFAULT;
  if((ID_W*2 + gap) > safeW){
    gap = Math.max(8, safeW - (ID_W*2));
  }

  const neededW = (ID_W*2) + gap;
  const startX = SAFE_MARGIN + (safeW - neededW)/2;
  const startY = TOP_OFFSET;

  drawContainPDF(pdf, face.dataUrl, face.format, startX, startY, ID_W, ID_H);
  drawContainPDF(pdf, back.dataUrl, back.format, startX + ID_W + gap, startY, ID_W, ID_H);
}

async function addSingleImagePage(pdf, file){
  const data = await loadImageDataForPDF(file);
  pdf.addPage("a4","p");

  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();

  const x = SAFE_MARGIN;
  const y = SAFE_MARGIN;
  const w = pageW - (SAFE_MARGIN * 2);
  const h = pageH - (SAFE_MARGIN * 2);

  drawContainPDF(pdf, data.dataUrl, data.format, x, y, w, h);
}

async function generatePDF(){
  const name = employeeName.value.trim();
  if(!name){ alert("يرجى إدخال اسم الموظف"); return; }

  if(!empFace.files[0] || !empBack.files[0]){
    alert("يرجى رفع وجه وظهر البطاقة الوطنية");
    return;
  }

  if(hasResidence.checked){
    if(!resFace.files[0] || !resBack.files[0]){
      alert("رفّع وجه وظهر بطاقة السكن");
      return;
    }
  }

  const pdf = new jsPDF({unit:"px", format:"a4"});

  await addIDPage(pdf, empFace.files[0], empBack.files[0]);

  if(hasResidence.checked)
    await addIDPage(pdf, resFace.files[0], resBack.files[0]);

  const wf = document.querySelectorAll(".wife-face");
  const wb = document.querySelectorAll(".wife-back");
  for(let i=0;i<wf.length;i++){
    if(wf[i].files[0] && wb[i].files[0]) await addIDPage(pdf, wf[i].files[0], wb[i].files[0]);
  }

  const cf = document.querySelectorAll(".child-face");
  const cb = document.querySelectorAll(".child-back");
  for(let i=0;i<cf.length;i++){
    if(cf[i].files[0] && cb[i].files[0]) await addIDPage(pdf, cf[i].files[0], cb[i].files[0]);
  }

  // التموينية/الشهادة: صفحات كاملة عادي
  if(hasRation.checked){
    if(!rationFace.files[0]){ alert("رفّع البطاقة التموينية"); return; }
    await addSingleImagePage(pdf, rationFace.files[0]);
  }

  if(hasCertificate.checked){
    if(!certificateFile.files[0]){ alert("رفّع شهادة التخرج"); return; }
    await addSingleImagePage(pdf, certificateFile.files[0]);
  }

  if(pdf.getNumberOfPages() > 1) pdf.deletePage(1);

  pdf.save(name.replace(/\s+/g,"_") + "_documents.pdf");
}
</script>

</body>
</html>
