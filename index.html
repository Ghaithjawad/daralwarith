<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>استمارة تحديث بيانات موظفي دار الوارث</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --main:#1aa6a6;
  --dark:#148c8c;
  --border:#d9eeee;
  --text:#0f3f3f;
}
body{
  font-family:"Segoe UI",Tahoma,sans-serif;
  color:var(--text);
  background-image:url("background.png");
  background-repeat:repeat;
  background-size:420px 420px;
  background-attachment:fixed;
}
.container{
  background:#ffffff;
  border-radius:22px;
  padding:30px;
  margin:30px auto 25px;
  box-shadow:0 18px 40px rgba(0,0,0,.18);
}
.header{
  background:linear-gradient(135deg,var(--main),var(--dark));
  color:#fff;
  padding:30px;
  border-radius:18px;
  text-align:center;
  margin-bottom:30px;
}
.logo{ max-width:150px; display:block; margin:auto; }
.card{
  border:1px solid var(--border);
  border-radius:16px;
  margin-bottom:22px;
}
.section{
  border:2px dashed var(--main);
  border-radius:14px;
  padding:16px;
  margin-top:14px;
  background:#f9fefe;
}
.check-box{
  border:1.8px solid var(--main);
  border-radius:12px;
  padding:12px 16px;
  background:#f6fdfd;
}
.form-check-input{ width:18px; height:18px; margin-left:10px; }
.form-check-input:checked{ background-color:var(--main); border-color:var(--main); }

button.main-btn{
  background:var(--main);
  border:none;
  padding:16px;
  font-size:18px;
  border-radius:14px;
  color:#fff;
}
button.main-btn:hover{ background:var(--dark); }

.preview-img{
  max-height:180px;
  width:100%;
  object-fit:contain;
  border-radius:12px;
  border:1px solid #e8e8e8;
  background:#fff;
}

/* ===== كاميرا ===== */
.cam-wrap{ position:relative; width:100%; }
#camVideo{ width:100%; border-radius:12px; background:#000; }
.cam-overlay{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  pointer-events:none;
}
.id-frame{
  width:72%;
  aspect-ratio: 8.7 / 5.3;
  border:4px solid red;
  border-radius:14px;
  box-shadow:0 0 0 2000px rgba(0,0,0,.45);
}

.footer-note{
  text-align:center;
  margin:14px auto 25px;
  color:#0f3f3f;
  opacity:.85;
  font-weight:600;
}
.small-note{ font-size:.9rem; color:#666; }

.req-hint{ font-size:.85rem; color:#b42318; display:none; }
.req-hint.show{ display:block; }

.tip{
  background:#f2fffe;
  border:1px solid #cfeeee;
  border-radius:12px;
  padding:10px 12px;
  color:#0f3f3f;
  font-size:.92rem;
}
</style>
</head>

<body>

<div class="container">

  <div class="header">
    <img src="logo.png" class="logo mb-3" alt="دار الوارث">
    <h4 class="mb-1">استمارة تحديث بيانات موظفي دار الوارث</h4>
    <p class="mb-0">يرجى إدخال البيانات ورفع المستمسكات المطلوبة</p>
  </div>

  <div id="secureWarn" class="alert alert-warning d-none">
    الكاميرا لا تعمل إلا على <b>HTTPS</b> أو <b>localhost</b>. على GitHub Pages راح تشتغل (HTTPS).
  </div>

  <!-- ====== بيانات الموظف ====== -->
  <div class="card p-4">
    <label class="fw-bold">الاسم الرباعي (إجباري)</label>
    <input type="text" id="employeeName" class="form-control" placeholder="مثال: محمد علي حسن عباس">
    <div id="nameError" class="req-hint">الاسم لازم يكون 4 كلمات بالضبط</div>
  </div>

  <div class="card p-4">
    <div class="row g-3">
      <div class="col-md-6">
        <label class="fw-bold">محل الولادة</label>
        <input type="text" id="birthPlace" class="form-control">
      </div>
      <div class="col-md-6">
        <label class="fw-bold">المواليد (تاريخ الولادة)</label>
        <input type="date" id="birthDate" class="form-control">
      </div>
      <div class="col-md-6">
        <label class="fw-bold">رقم الهاتف</label>
        <input type="tel" id="phone" class="form-control" placeholder="07xxxxxxxxx">
      </div>
      <div class="col-md-6">
        <label class="fw-bold">رقم باج العتبة الحسينية المقدسة</label>
        <input type="text" id="badgeNumber" class="form-control">
      </div>
      <div class="col-md-6">
        <label class="fw-bold">التحصيل الدراسي</label>
        <select id="education" class="form-control">
          <option value="">اختر</option>
          <option>ابتدائية</option>
          <option>متوسطة</option>
          <option>إعدادية</option>
          <option>دبلوم</option>
          <option>بكالوريوس</option>
          <option>ماجستير</option>
          <option>دكتوراه</option>
        </select>
      </div>
      <div class="col-md-6">
        <label class="fw-bold">التخصص الدقيق</label>
        <input type="text" id="specialty" class="form-control">
      </div>
      <div class="col-12">
        <label class="fw-bold">عنوان السكن الحالي</label>
        <textarea id="address" class="form-control" rows="2"></textarea>
      </div>
    </div>
  </div>

  <!-- ====== الحالة الاجتماعية ====== -->
  <div class="card p-4">
    <label class="fw-bold mb-2 d-block">الحالة الاجتماعية</label>
    <select id="maritalStatus" class="form-control">
      <option value="">اختر</option>
      <option value="single">أعزب</option>
      <option value="married">متزوج</option>
    </select>

    <div id="socialSection" class="section d-none">
      <div class="row g-3">

        <!-- ✅ عدد الزوجات قبل الأسماء -->
        <div class="col-md-6">
          <label class="fw-bold">عدد الزوجات</label>
          <input type="number" id="wivesCount" min="1" value="1" class="form-control">
        </div>

        <div class="col-12">
          <div id="wivesInfo"></div>
          <div id="wivesUploads"></div>
        </div>

        <div class="col-md-6">
          <label class="fw-bold">اسم أم الأبناء</label>
          <input type="text" id="childrenMother" class="form-control">
        </div>

        <div class="col-md-6">
          <label class="fw-bold">عدد الأبناء</label>
          <input type="number" id="childrenCount" min="0" value="0" class="form-control">
        </div>

        <div class="col-12">
          <div id="childrenNamesWrap"></div>
          <div id="childrenUploads"></div>
        </div>

      </div>
    </div>
  </div>

  <!-- ====== البطاقة الوطنية ====== -->
  <div class="card p-4">
    <h5 class="mb-2">البطاقة الوطنية للموظف <span class="text-muted">(قص ذكي داخل قوسين)</span></h5>
    <div class="tip mb-3">
      التعليمات: وجّه الهوية داخل الإطار، لا تحرك اليد، خلي الإضاءة قوية. يصير الإطار أخضر وبعدها يلتقط تلقائياً.
    </div>

    <div class="mb-3">
      <label class="fw-bold mb-2 d-block">وجه الهوية</label>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('empFace')">كاميرا</button>
        <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('empFace')">استوديو</button>
      </div>
      <input type="file" id="empFace" class="form-control d-none" accept="image/*">
      <img id="empFacePreview" class="preview-img mt-2 d-none" alt="preview">
    </div>

    <div>
      <label class="fw-bold mb-2 d-block">ظهر الهوية</label>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('empBack')">كاميرا</button>
        <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('empBack')">استوديو</button>
      </div>
      <input type="file" id="empBack" class="form-control d-none" accept="image/*">
      <img id="empBackPreview" class="preview-img mt-2 d-none" alt="preview">
    </div>
  </div>

  <!-- ====== بطاقة السكن ====== -->
  <div class="card p-4">
    <div class="check-box form-check">
      <label class="form-check-label">هل توجد بطاقة سكن؟</label>
      <input class="form-check-input" type="checkbox" id="hasResidence">
    </div>

    <div id="residenceSection" class="section d-none">
      <div class="mb-3">
        <label class="fw-bold mb-2 d-block">وجه بطاقة السكن</label>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('resFace')">كاميرا</button>
          <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('resFace')">استوديو</button>
        </div>
        <input type="file" id="resFace" class="form-control d-none" accept="image/*">
        <img id="resFacePreview" class="preview-img mt-2 d-none" alt="preview">
      </div>

      <div>
        <label class="fw-bold mb-2 d-block">ظهر بطاقة السكن</label>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('resBack')">كاميرا</button>
          <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('resBack')">استوديو</button>
        </div>
        <input type="file" id="resBack" class="form-control d-none" accept="image/*">
        <img id="resBackPreview" class="preview-img mt-2 d-none" alt="preview">
      </div>
    </div>
  </div>

  <!-- ====== باج العتبة ====== -->
  <div class="card p-4">
    <div class="check-box form-check">
      <label class="form-check-label">هل يوجد باج العتبة؟</label>
      <input class="form-check-input" type="checkbox" id="hasBadge">
    </div>

    <div id="badgeSection" class="section d-none">
      <div class="tip mb-3">ضع الباج داخل الإطار تماماً، يتحول أخضر ثم يلتقط تلقائياً.</div>

      <div class="mb-3">
        <label class="fw-bold mb-2 d-block">وجه باج العتبة</label>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('badgeFace')">كاميرا</button>
          <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('badgeFace')">استوديو</button>
        </div>
        <input type="file" id="badgeFace" class="form-control d-none" accept="image/*">
        <img id="badgeFacePreview" class="preview-img mt-2 d-none" alt="preview">
      </div>

      <div>
        <label class="fw-bold mb-2 d-block">ظهر باج العتبة</label>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('badgeBack')">كاميرا</button>
          <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('badgeBack')">استوديو</button>
        </div>
        <input type="file" id="badgeBack" class="form-control d-none" accept="image/*">
        <img id="badgeBackPreview" class="preview-img mt-2 d-none" alt="preview">
      </div>
    </div>
  </div>

  <!-- ====== شهادة التخرج (بدون قص) ====== -->
  <div class="card p-4">
    <div class="check-box form-check">
      <label class="form-check-label">هل توجد شهادة تخرج؟</label>
      <input class="form-check-input" type="checkbox" id="hasCertificate">
    </div>

    <div id="certificateSection" class="section d-none">
      <label class="fw-bold mb-2 d-block">صورة شهادة التخرج (بدون قص)</label>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('certificateFile')">كاميرا</button>
        <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('certificateFile')">استوديو</button>
      </div>
      <input type="file" id="certificateFile" class="form-control d-none" accept="image/*">
      <img id="certificateFilePreview" class="preview-img mt-2 d-none" alt="preview">
    </div>
  </div>

  <button class="w-100 main-btn" onclick="submitAll()">إرسال (Google Sheet + PDF)</button>

  <div class="mt-3 small-note">
    الوطني + السكن + باج + زوجات/أطفال: قص داخل الإطار + فحص إضاءة/وضوح + Best Shot. <br>
    الشهادة: تصوير/رفع كامل بدون قص.
  </div>

</div>

<div class="footer-note">تطوير شعبة تقنية المعلومات لدار الوارث</div>

<!-- ارسال إلى Google Sheet بدون CORS: iframe + form -->
<iframe id="gsFrame" name="gsFrame" style="display:none;"></iframe>
<form id="gsForm" target="gsFrame" method="POST" style="display:none;">
  <input name="employeeName">
  <input name="birthPlace">
  <input name="birthDate">
  <input name="phone">
  <input name="badgeNumber">
  <input name="education">
  <input name="specialty">
  <input name="address">
  <input name="maritalStatus">
  <input name="wivesCount">
  <input name="wivesInfo">
  <input name="childrenMother">
  <input name="childrenCount">
  <input name="childrenNames">
  <input name="hasResidence">
  <input name="hasBadge">
  <input name="hasCertificate">
</form>

<!-- مودال الكاميرا -->
<div class="modal fade" id="camModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="camTitle">كاميرا</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="closeCamera()"></button>
      </div>

      <div class="modal-body">
        <div class="cam-wrap">
          <video id="camVideo" autoplay playsinline></video>
          <div class="cam-overlay">
            <div id="idFrame" class="id-frame"></div>
          </div>
        </div>
        <div class="mt-2">
          <small class="text-muted" id="camHint">وجّه المستند داخل الإطار</small>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeCamera()">إغلاق</button>
        <button type="button" class="btn btn-success" id="captureBtn" onclick="captureNow()">التقاط</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* =======================
   ضع رابط Apps Script WebApp (/exec) هنا
   مثال: https://script.google.com/macros/s/XXXXXXX/exec
======================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyo5WP7AZVQwegbpttl9D1ipEr9_MeitC4kNjiqLfkDc43Sh2KfjQ_hksX6JuqExf_Duw/exec";

/* ===== HTTPS/localhost check ===== */
function isCameraAllowedContext(){
  const isLocalhost = ["localhost","127.0.0.1"].includes(location.hostname);
  return window.isSecureContext || isLocalhost;
}
(function(){
  document.getElementById("secureWarn").classList.toggle("d-none", isCameraAllowedContext());
})();

/* ===== Studio + preview ===== */
function openStudio(inputId){
  const el = document.getElementById(inputId);
  if(el) el.click();
}
function bindPreview(inputId){
  const input = document.getElementById(inputId);
  if(!input) return;
  input.addEventListener("change", ()=>{
    const file = input.files && input.files[0];
    const prev = document.getElementById(inputId+"Preview");
    if(file && prev){
      prev.src = URL.createObjectURL(file);
      prev.classList.remove("d-none");
    }
  });
}
["empFace","empBack","resFace","resBack","badgeFace","badgeBack","certificateFile"].forEach(bindPreview);

/* ===== الاسم الرباعي ===== */
function isQuadName(name){
  const words = name.trim().split(/\s+/).filter(Boolean);
  return words.length === 4;
}
employeeName.addEventListener("input", ()=>{
  const ok = isQuadName(employeeName.value);
  document.getElementById("nameError").classList.toggle("show", !ok && employeeName.value.trim().length>0);
});

/* ===== Sections ===== */
hasResidence.onchange = ()=> residenceSection.classList.toggle("d-none", !hasResidence.checked);
hasBadge.onchange     = ()=> badgeSection.classList.toggle("d-none", !hasBadge.checked);
hasCertificate.onchange = ()=> certificateSection.classList.toggle("d-none", !hasCertificate.checked);

/* ===== الحالة الاجتماعية ===== */
maritalStatus.addEventListener("change", ()=>{
  const married = maritalStatus.value === "married";
  socialSection.classList.toggle("d-none", !married);

  if(!married){
    wivesCount.value = 1;
    wivesInfo.innerHTML = "";
    wivesUploads.innerHTML = "";
    childrenMother.value = "";
    childrenCount.value = 0;
    childrenNamesWrap.innerHTML = "";
    childrenUploads.innerHTML = "";
  }else{
    renderWivesAll();
    renderChildrenAll();
  }
});
wivesCount.addEventListener("input", ()=>{
  if(maritalStatus.value === "married") renderWivesAll();
});
childrenCount.addEventListener("input", ()=>{
  if(maritalStatus.value === "married") renderChildrenAll();
});

/* ===== Dynamic: wives names + employed + IDs (ذكي) ===== */
function makeSmartIDBlock(prefix, i){
  const faceId = `${prefix}Face_${i}`;
  const backId = `${prefix}Back_${i}`;
  const title = (prefix==="wife") ? `هوية الزوجة ${i}` : `هوية الطفل ${i}`;

  return `
    <div class="mb-3 p-3 rounded border bg-white">
      <strong class="d-block mb-2">${title}</strong>

      <div class="mb-2">
        <label class="fw-bold mb-1 d-block">وجه</label>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('${faceId}')">كاميرا</button>
          <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('${faceId}')">استوديو</button>
        </div>
        <input type="file" id="${faceId}" class="form-control d-none ${prefix}-face" accept="image/*">
        <img id="${faceId}Preview" class="preview-img mt-2 d-none" alt="preview">
      </div>

      <div>
        <label class="fw-bold mb-1 d-block">ظهر</label>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary w-50" onclick="openCameraFor('${backId}')">كاميرا</button>
          <button type="button" class="btn btn-outline-secondary w-50" onclick="openStudio('${backId}')">استوديو</button>
        </div>
        <input type="file" id="${backId}" class="form-control d-none ${prefix}-back" accept="image/*">
        <img id="${backId}Preview" class="preview-img mt-2 d-none" alt="preview">
      </div>
    </div>
  `;
}
function bindDynamicPreviews(prefix, n){
  for(let i=1;i<=n;i++){
    bindPreview(`${prefix}Face_${i}`);
    bindPreview(`${prefix}Back_${i}`);
  }
}

function renderWivesAll(){
  const n = Math.max(1, Number(wivesCount.value || 1));

  wivesInfo.innerHTML = `<div class="tip mb-2">بيانات الزوجات</div>`;
  let html = "";
  for(let i=1;i<=n;i++){
    html += `
      <div class="mb-3 p-3 rounded border bg-white">
        <strong class="d-block mb-2">الزوجة ${i}</strong>
        <div class="row g-2">
          <div class="col-md-6">
            <label class="fw-bold">اسم الزوجة الثلاثي</label>
            <input type="text" class="form-control wifeName" id="wifeName_${i}" placeholder="مثال: زهراء علي حسن">
          </div>
          <div class="col-md-6">
            <label class="fw-bold">هل هي موظفة؟</label>
            <select class="form-control wifeEmp" id="wifeEmp_${i}">
              <option value="">اختر</option>
              <option value="yes">نعم</option>
              <option value="no">لا</option>
            </select>
          </div>
        </div>
      </div>
    `;
  }
  wivesInfo.innerHTML += html;

  wivesUploads.innerHTML = `<div class="tip mb-2">رفع هويات الزوجات (ذكي مثل الوطنية)</div>`;
  for(let i=1;i<=n;i++){
    wivesUploads.innerHTML += makeSmartIDBlock("wife", i);
  }
  bindDynamicPreviews("wife", n);
}

function renderChildrenAll(){
  const n = Math.max(0, Number(childrenCount.value || 0));

  childrenNamesWrap.innerHTML = "";
  if(n > 0){
    const box = document.createElement("div");
    box.className = "section";
    box.innerHTML = `<div class="fw-bold mb-2">أسماء الأبناء</div>`;
    for(let i=1;i<=n;i++){
      const div = document.createElement("div");
      div.className = "mb-2";
      div.innerHTML = `
        <label class="fw-bold">اسم الابن ${i}</label>
        <input type="text" class="form-control childName" id="childName_${i}">
      `;
      box.appendChild(div);
    }
    childrenNamesWrap.appendChild(box);
  }

  childrenUploads.innerHTML = "";
  if(n > 0){
    childrenUploads.innerHTML = `<div class="tip mb-2">رفع هويات الأطفال (ذكي مثل الوطنية)</div>`;
    for(let i=1;i<=n;i++){
      childrenUploads.innerHTML += makeSmartIDBlock("child", i);
    }
    bindDynamicPreviews("child", n);
  }
}

/* =========================
   CAMERA (ID ذكي / FULL كامل)
========================= */
function isSmartIDInput(inputId){
  if(["empFace","empBack","resFace","resBack","badgeFace","badgeBack"].includes(inputId)) return true;
  if(/^wifeFace_\d+$/.test(inputId)) return true;
  if(/^wifeBack_\d+$/.test(inputId)) return true;
  if(/^childFace_\d+$/.test(inputId)) return true;
  if(/^childBack_\d+$/.test(inputId)) return true;
  return false;
}

let camStream = null;
let targetInputId = null;
let camModal = null;
let validateTimer = null;

let greenSince = null;
let lastAuto = 0;
let bestShotLock = false;

let captureMode = "ID"; // "ID" or "FULL"

async function openCameraFor(inputId){
  if(!isCameraAllowedContext()){
    alert("الكاميرا ما تشتغل إلا على HTTPS أو localhost.\nعلى GitHub Pages راح تشتغل تلقائياً.");
    return;
  }

  targetInputId = inputId;
  captureMode = isSmartIDInput(inputId) ? "ID" : "FULL";

  if(!camModal) camModal = new bootstrap.Modal(document.getElementById("camModal"));

  try{
    camStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode:"environment" },
      audio:false
    });

    const v = document.getElementById("camVideo");
    v.srcObject = camStream;

    const frameEl = document.getElementById("idFrame");
    const titleEl = document.getElementById("camTitle");
    const hint = document.getElementById("camHint");

    if(captureMode === "ID"){
      frameEl.style.display = "block";
      frameEl.style.borderColor = "red";
      titleEl.textContent = "كاميرا (قص ذكي داخل الإطار)";
      hint.textContent = "ضع البطاقة داخل الإطار — يصير أخضر ثم يلتقط تلقائياً";

      bestShotLock = false; greenSince = null; lastAuto = 0;
      if(validateTimer) clearInterval(validateTimer);
      validateTimer = setInterval(()=>validateFrameFast(), 110);
    }else{
      frameEl.style.display = "none";
      titleEl.textContent = "كاميرا (بدون قص)";
      hint.textContent = "التقاط صورة كاملة";

      if(validateTimer) { clearInterval(validateTimer); validateTimer=null; }
      bestShotLock = false; greenSince = null; lastAuto = 0;
    }

    camModal.show();

  }catch(e){
    alert("تعذر تشغيل الكاميرا. تأكد من إعطاء الصلاحية.");
    console.error(e);
  }
}

function closeCamera(){
  if(validateTimer){ clearInterval(validateTimer); validateTimer=null; }
  if(camStream){
    camStream.getTracks().forEach(t=>t.stop());
    camStream = null;
  }
  document.getElementById("idFrame").style.borderColor = "red";
  greenSince = null;
  bestShotLock = false;
}

function captureNow(){
  if(captureMode === "ID") bestShotCapture();
  else captureFullNow();
}

function analyzeLightSharpFastFromVideoROI(){
  const v = document.getElementById("camVideo");
  const roi = getCropRectInVideoPixels();
  if(!roi) return null;

  const testW = 220;
  const testH = Math.max(1, Math.round(testW * (roi.h / roi.w)));

  const c = document.createElement("canvas");
  c.width = testW;
  c.height = testH;
  const ctx = c.getContext("2d", { willReadFrequently:true });
  ctx.drawImage(v, roi.x, roi.y, roi.w, roi.h, 0, 0, testW, testH);

  const img = ctx.getImageData(0,0,testW,testH);
  return analyzeROI_lightSharp(img.data, testW, testH, 0, 0, testW, testH);
}

function validateFrameFast(){
  if(captureMode !== "ID") return;

  const frameEl = document.getElementById("idFrame");
  const hint = document.getElementById("camHint");

  const stats = analyzeLightSharpFastFromVideoROI();
  if(!stats) return;

  const okLight = stats.mean > 60 && stats.mean < 205;
  const okSharp = stats.blurScore > 20;
  const ok = okLight && okSharp;

  frameEl.style.borderColor = ok ? "lime" : "red";

  if(ok){
    hint.textContent = "✅ ممتاز — سيتم الالتقاط تلقائياً";
    if(greenSince === null) greenSince = performance.now();
    autoCaptureTick();
  }else{
    greenSince = null;
    if(!okLight) hint.textContent = "⚠️ الإضاءة غير مناسبة — قرّب للضوء أو ابتعد شوي";
    else hint.textContent = "⚠️ مو واضح — ثبّت يدك/قرّب البطاقة";
  }
}

function autoCaptureTick(){
  if(bestShotLock) return;
  const now = performance.now();
  const needGreenMs = 260;
  const cooldownMs  = 900;

  if(greenSince === null) return;
  if(now - greenSince < needGreenMs) return;
  if(now - lastAuto < cooldownMs) return;

  lastAuto = now;
  bestShotCapture();
}

function analyzeROI_lightSharp(data, w, h, x0, y0, rw, rh){
  let sum=0, count=0;
  const gray = new Uint8ClampedArray(rw*rh);
  let k=0;

  for(let y=y0; y<y0+rh; y++){
    for(let x=x0; x<x0+rw; x++){
      const i=(y*w+x)*4;
      const g = (data[i]*0.299 + data[i+1]*0.587 + data[i+2]*0.114) | 0;
      gray[k++] = g;
      sum += g; count++;
    }
  }
  const mean = sum / count;

  let lapSum=0;
  for(let y=1; y<rh-1; y++){
    for(let x=1; x<rw-1; x++){
      const c = gray[y*rw+x];
      const lap = Math.abs(
        (gray[(y-1)*rw+x] + gray[(y+1)*rw+x] + gray[y*rw+(x-1)] + gray[y*rw+(x+1)]) - 4*c
      );
      lapSum += lap;
    }
  }
  const blurScore = lapSum / ((rw-2)*(rh-2));
  return { mean, blurScore };
}

function sleep(ms){ return new Promise(res=>setTimeout(res, ms)); }

function getCropRectInVideoPixels(){
  const v = document.getElementById("camVideo");
  const frame = document.getElementById("idFrame");
  if(!v.videoWidth || !v.videoHeight) return null;

  const vr = v.getBoundingClientRect();
  const fr = frame.getBoundingClientRect();

  const left   = Math.max(fr.left, vr.left);
  const top    = Math.max(fr.top, vr.top);
  const right  = Math.min(fr.right, vr.right);
  const bottom = Math.min(fr.bottom, vr.bottom);

  const wCss = Math.max(0, right - left);
  const hCss = Math.max(0, bottom - top);
  if(wCss < 10 || hCss < 10) return null;

  const sx = (left - vr.left) * (v.videoWidth  / vr.width);
  const sy = (top  - vr.top ) * (v.videoHeight / vr.height);
  const sw = wCss * (v.videoWidth  / vr.width);
  const sh = hCss * (v.videoHeight / vr.height);

  const x = Math.max(0, Math.min(v.videoWidth - 1, sx));
  const y = Math.max(0, Math.min(v.videoHeight - 1, sy));
  const w = Math.max(1, Math.min(v.videoWidth  - x, sw));
  const h = Math.max(1, Math.min(v.videoHeight - y, sh));

  return { x, y, w, h };
}

async function bestShotCapture(){
  if(bestShotLock) return;
  bestShotLock = true;
  try{
    const shots = [];
    for(let i=0;i<3;i++){
      const shot = grabCroppedFrameWithScore();
      if(shot) shots.push(shot);
      await sleep(110);
    }
    if(!shots.length) throw new Error("No shots");

    shots.sort((a,b)=>b.score - a.score);
    const best = shots[0];

    await saveDataUrlToInput(best.dataUrl);

    camModal.hide();
    closeCamera();
  }catch(e){
    console.error(e);
    alert("صار خطأ بالالتقاط. جرّب مرة ثانية.");
    bestShotLock = false;
  }
}

function grabCroppedFrameWithScore(){
  const v = document.getElementById("camVideo");
  const roi = getCropRectInVideoPixels();
  if(!roi) return null;

  const canvas = document.createElement("canvas");
  canvas.width = Math.max(1, Math.round(roi.w));
  canvas.height = Math.max(1, Math.round(roi.h));
  const ctx = canvas.getContext("2d", { willReadFrequently:true });
  ctx.drawImage(v, roi.x, roi.y, roi.w, roi.h, 0, 0, canvas.width, canvas.height);

  const testW = 240;
  const testH = Math.max(1, Math.round(testW * (canvas.height / canvas.width)));
  const c2 = document.createElement("canvas");
  c2.width = testW;
  c2.height = testH;
  const x2 = c2.getContext("2d", { willReadFrequently:true });
  x2.drawImage(canvas,0,0,testW,testH);
  const img = x2.getImageData(0,0,testW,testH);
  const st = analyzeROI_lightSharp(img.data, testW, testH, 0, 0, testW, testH);

  const dataUrl = canvas.toDataURL("image/jpeg", 0.92);
  return { dataUrl, score: st.blurScore };
}

async function captureFullNow(){
  const v = document.getElementById("camVideo");
  if(!v.videoWidth) return;

  const canvas = document.createElement("canvas");
  canvas.width = v.videoWidth;
  canvas.height = v.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(v,0,0,canvas.width,canvas.height);

  const dataUrl = canvas.toDataURL("image/jpeg", 0.9);
  await saveDataUrlToInput(dataUrl);

  camModal.hide();
  closeCamera();
}

async function saveDataUrlToInput(dataUrl){
  const blob = await (await fetch(dataUrl)).blob();
  const file = new File([blob], "camera.jpg", {type:"image/jpeg"});
  const dt = new DataTransfer();
  dt.items.add(file);

  const input = document.getElementById(targetInputId);
  input.files = dt.files;

  const prev = document.getElementById(targetInputId+"Preview");
  if(prev){
    prev.src = URL.createObjectURL(file);
    prev.classList.remove("d-none");
  }
}

/* =========================
   PDF: 8.7×5.3 سم + Margins آمنة
========================= */
const { jsPDF } = window.jspdf;
const CM = 28.35;
const SAFE_MARGIN = 2 * CM;
const ID_W = 8.7 * CM;
const ID_H = 5.3 * CM;
const GAP_DEFAULT = 20;
const TOP_OFFSET = 3.8 * CM;

async function loadImageDataForPDF(file){
  const dataUrl = await new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=e=>resolve(e.target.result);
    r.onerror=reject;
    r.readAsDataURL(file);
  });

  const img = await new Promise((resolve,reject)=>{
    const i=new Image();
    i.onload=()=>resolve(i);
    i.onerror=reject;
    i.src=dataUrl;
  });

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  const maxW = 2000;
  const scale = Math.min(1, maxW / img.width);

  canvas.width = Math.round(img.width * scale);
  canvas.height = Math.round(img.height * scale);
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

  return { dataUrl: canvas.toDataURL("image/jpeg", 0.9), format: "JPEG" };
}

function drawContainPDF(pdf, dataUrl, format, x, y, w, h){
  const p = pdf.getImageProperties(dataUrl);
  const s = Math.min(w/p.width, h/p.height);
  const nw = p.width*s, nh = p.height*s;
  const nx = x + (w-nw)/2;
  const ny = y + (h-nh)/2;
  pdf.addImage(dataUrl, format, nx, ny, nw, nh);
}

async function addIDPage(pdf, faceFile, backFile){
  const face = await loadImageDataForPDF(faceFile);
  const back = await loadImageDataForPDF(backFile);

  pdf.addPage("a4","p");

  const pageW = pdf.internal.pageSize.getWidth();
  const safeW = pageW - (SAFE_MARGIN * 2);

  let gap = GAP_DEFAULT;
  if((ID_W*2 + gap) > safeW){
    gap = Math.max(8, safeW - (ID_W*2));
  }

  const neededW = (ID_W*2) + gap;
  const startX = SAFE_MARGIN + (safeW - neededW)/2;
  const startY = TOP_OFFSET;

  drawContainPDF(pdf, face.dataUrl, face.format, startX, startY, ID_W, ID_H);
  drawContainPDF(pdf, back.dataUrl, back.format, startX + ID_W + gap, startY, ID_W, ID_H);
}

async function addSingleImagePage(pdf, file){
  const data = await loadImageDataForPDF(file);
  pdf.addPage("a4","p");

  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();

  const x = SAFE_MARGIN;
  const y = SAFE_MARGIN;
  const w = pageW - (SAFE_MARGIN * 2);
  const h = pageH - (SAFE_MARGIN * 2);

  drawContainPDF(pdf, data.dataUrl, data.format, x, y, w, h);
}

/* =========================
   Google Sheet إرسال (بدون CORS)
========================= */
function collectWivesInfo(){
  const married = maritalStatus.value === "married";
  if(!married) return [];
  const n = Math.max(1, Number(wivesCount.value || 1));
  const arr = [];
  for(let i=1;i<=n;i++){
    const name = (document.getElementById(`wifeName_${i}`)?.value || "").trim();
    const empV = (document.getElementById(`wifeEmp_${i}`)?.value || "");
    arr.push({
      index: i,
      name,
      isEmployee: empV === "yes" ? true : (empV === "no" ? false : null)
    });
  }
  return arr;
}

function collectChildrenNames(){
  const married = maritalStatus.value === "married";
  if(!married) return [];
  const n = Math.max(0, Number(childrenCount.value || 0));
  const arr = [];
  for(let i=1;i<=n;i++){
    const nm = (document.getElementById(`childName_${i}`)?.value || "").trim();
    arr.push(nm);
  }
  return arr;
}

function sendToGoogleSheet(){
  if(!SCRIPT_URL || SCRIPT_URL.includes("PASTE_YOUR_WEB_APP_EXEC_URL_HERE")){
    alert("لازم تحط رابط Google Apps Script WebApp (/exec) داخل SCRIPT_URL");
    return false;
  }

  const form = document.getElementById("gsForm");
  form.action = SCRIPT_URL;

  form.elements.employeeName.value = employeeName.value.trim();
  form.elements.birthPlace.value = birthPlace.value.trim();
  form.elements.birthDate.value = birthDate.value || "";
  form.elements.phone.value = phone.value.trim();
  form.elements.badgeNumber.value = badgeNumber.value.trim();
  form.elements.education.value = education.value || "";
  form.elements.specialty.value = specialty.value.trim();
  form.elements.address.value = address.value.trim();
  form.elements.maritalStatus.value = maritalStatus.value || "";

  const married = maritalStatus.value === "married";
  form.elements.wivesCount.value = married ? (String(wivesCount.value || "1")) : "";
  form.elements.wivesInfo.value = JSON.stringify(collectWivesInfo());
  form.elements.childrenMother.value = married ? childrenMother.value.trim() : "";
  form.elements.childrenCount.value = married ? (String(childrenCount.value || "0")) : "";
  form.elements.childrenNames.value = JSON.stringify(collectChildrenNames());

  form.elements.hasResidence.value = hasResidence.checked ? "1" : "0";
  form.elements.hasBadge.value = hasBadge.checked ? "1" : "0";
  form.elements.hasCertificate.value = hasCertificate.checked ? "1" : "0";

  form.submit();
  return true;
}

/* =========================
   Validation + PDF
========================= */
async function generatePDF(){
  const name = employeeName.value.trim();
  if(!name){ alert("يرجى إدخال الاسم"); return false; }
  if(!isQuadName(name)){ alert("الاسم يجب أن يكون رباعي (4 كلمات)"); return false; }

  if(!empFace.files[0] || !empBack.files[0]){
    alert("يرجى رفع وجه وظهر البطاقة الوطنية");
    return false;
  }

  if(hasResidence.checked){
    if(!resFace.files[0] || !resBack.files[0]){
      alert("رفّع وجه وظهر بطاقة السكن");
      return false;
    }
  }

  if(hasBadge.checked){
    if(!badgeFace.files[0] || !badgeBack.files[0]){
      alert("رفّع وجه وظهر باج العتبة");
      return false;
    }
  }

  const married = maritalStatus.value === "married";
  if(married){
    const wCount = Math.max(1, Number(wivesCount.value || 1));
    for(let i=1;i<=wCount;i++){
      const nm = (document.getElementById(`wifeName_${i}`)?.value || "").trim();
      const emp = (document.getElementById(`wifeEmp_${i}`)?.value || "");
      if(!nm){ alert(`يرجى إدخال اسم الزوجة رقم ${i}`); return false; }
      if(!emp){ alert(`يرجى تحديد هل الزوجة رقم ${i} موظفة؟`); return false; }

      const wf = document.getElementById(`wifeFace_${i}`);
      const wb = document.getElementById(`wifeBack_${i}`);
      if(!wf?.files[0] || !wb?.files[0]){
        alert(`يرجى رفع وجه وظهر هوية الزوجة رقم ${i}`);
        return false;
      }
    }

    const cCount = Math.max(0, Number(childrenCount.value || 0));
    if(cCount>0){
      if(!childrenMother.value.trim()){ alert("يرجى إدخال اسم أم الأبناء"); return false; }
      const names = collectChildrenNames().filter(Boolean);
      if(names.length < cCount){ alert("يرجى إدخال أسماء الأبناء كاملة حسب العدد"); return false; }

      for(let i=1;i<=cCount;i++){
        const cf = document.getElementById(`childFace_${i}`);
        const cb = document.getElementById(`childBack_${i}`);
        if(!cf?.files[0] || !cb?.files[0]){
          alert(`يرجى رفع وجه وظهر هوية الطفل رقم ${i}`);
          return false;
        }
      }
    }
  }

  const pdf = new jsPDF({unit:"px", format:"a4"});

  await addIDPage(pdf, empFace.files[0], empBack.files[0]);

  if(hasResidence.checked){
    await addIDPage(pdf, resFace.files[0], resBack.files[0]);
  }

  if(hasBadge.checked){
    await addIDPage(pdf, badgeFace.files[0], badgeBack.files[0]);
  }

  if(married){
    const wCount = Math.max(1, Number(wivesCount.value || 1));
    for(let i=1;i<=wCount;i++){
      const wf = document.getElementById(`wifeFace_${i}`).files[0];
      const wb = document.getElementById(`wifeBack_${i}`).files[0];
      await addIDPage(pdf, wf, wb);
    }

    const cCount = Math.max(0, Number(childrenCount.value || 0));
    for(let i=1;i<=cCount;i++){
      const cf = document.getElementById(`childFace_${i}`).files[0];
      const cb = document.getElementById(`childBack_${i}`).files[0];
      await addIDPage(pdf, cf, cb);
    }
  }

  if(hasCertificate.checked){
    if(!certificateFile.files[0]){ alert("يرجى رفع شهادة التخرج"); return false; }
    await addSingleImagePage(pdf, certificateFile.files[0]);
  }

  if(pdf.getNumberOfPages() > 1) pdf.deletePage(1);

  pdf.save(name.replace(/\s+/g,"_") + "_documents.pdf");
  return true;
}

/* زر الإرسال: Google Sheet + PDF */
async function submitAll(){
  // 1) Validate PDF first (حتى ما نرسل بيانات ناقصة)
  const okPdf = await generatePDF();
  if(!okPdf) return;

  // 2) بعد نجاح الـ PDF نرسل للشيت
  const okSheet = sendToGoogleSheet();
  if(okSheet) alert("تم إنشاء PDF وإرسال البيانات إلى Google Sheet ✅");
}
</script>

</body>
</html>
